- en: '5'
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Regime Definition
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: During the Napoleonic wars, field surgeons with limited resources had to make
    quick decisions as to whom would need surgery, who could survive without, and
    the unfortunate ones for whom nothing could be done. Triage was born out of necessity
    to allocate limited time and resources in the most efficient and humane way possible.
    In the stock market, regime is another word for triage. Some are bullish, some
    are bearish, and some are inconclusive.
  prefs: []
  type: TYPE_NORMAL
- en: Markets tend to "stay wrong" a lot longer than investors tend to stick with
    you. Segregating stocks into different regime buckets—triaging them—before performing
    in-depth analysis is an efficient allocation of resources. The objective of this
    initial triage is not to predict where stocks could, would, or should be headed,
    but to practice the long-lost art of actively listening to what the market has
    to say.
  prefs: []
  type: TYPE_NORMAL
- en: Some market participants like to spend time and resources on building bear theses
    for stocks that stubbornly defy the gravity of reason. This is not efficient for
    two reasons. First, they expect reversion to the mean. On the long side, they
    trade trends and ride outperformers, expecting them to continue to do well. Meanwhile,
    on the short side, they trade mean reversion and expect expensive stocks to choke
    on humble pie and come back down to cheap prices again.
  prefs: []
  type: TYPE_NORMAL
- en: As we will analyze in the coming chapters, trend following and mean reversion
    have opposite pay-offs and risk profiles. Long trend-following and short mean-reversion
    does not reduce risk. It compounds it. For now, it suffices to say that market
    participants must make a choice. Either they trade trends expecting them to develop,
    or inefficiencies expecting them to correct. When they choose to trade both trends
    and inefficiencies, their investment style is incongruent. They invite the worst
    outcome of each style, which unsurprisingly tends to happen simultaneously at
    the worst time.
  prefs: []
  type: TYPE_NORMAL
- en: Secondly, expecting stocks to revert is essentially like trying to time the
    top. It is like standing in the middle of the tracks expecting freight train after
    freight train to stop. Bull regimes tend to outlast investors' patience for gallantry.
    It is more prudent to wait for more information to surface and the tide to turn
    bearish before placing a short.
  prefs: []
  type: TYPE_NORMAL
- en: As a different approach, establishing a market regime is something that could
    really help fundamental short-sellers. They often show up too early. They place
    their bets long before the broader market starts to factor in the information.
    The difference between a short selling guru and the dreaded tap on the shoulder
    is 6 months. Short internet stocks in 1999, and you'll be teaching math to bored
    university students in 2000\. Short the same stocks as early as late January 2000,
    and a new short selling star is born.
  prefs: []
  type: TYPE_NORMAL
- en: 'In the following sections, we will look at various regime definition methods,
    before comparing them:'
  prefs: []
  type: TYPE_NORMAL
- en: Importing libraries
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Creating a charting function
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Breakout/breakdown
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Moving averages
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Higher highs/higher lows
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Floor/ceiling
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Methodology comparison
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Let the market regime dictate the best strategy
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'You can access color versions of all images in this chapter via the following
    link: [https://static.packt-cdn.com/downloads/9781801815192_ColorImages.pdf](https://static.packt-cdn.com/downloads/9781801815192_ColorImages.pdf).
    You can also access source code for this chapter via the book''s GitHub repository:
    [https://github.com/PacktPublishing/Algorithmic-Short-Selling-with-Python-Published-by-Packt](https://github.com/PacktPublishing/Algorithmic-Short-Selling-with-Python-Published-by-Packt)'
  prefs: []
  type: TYPE_NORMAL
- en: Importing libraries
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: For this chapter and the rest of the book, we will be working with the `pandas`,
    `numpy`, `yfinance`, and `matplotlib` libraries. We will also be working with
    `find_peaks` from the ScientificPython library.
  prefs: []
  type: TYPE_NORMAL
- en: 'So, please remember to import them first:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE0]'
  prefs: []
  type: TYPE_PRE
- en: Creating a charting function
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Before we visually compare various regime methods, let's publish the source
    code for a colorful charting function called `graph_regime_combo`. The parameters
    will gradually make sense as we unveil each method.
  prefs: []
  type: TYPE_NORMAL
- en: 'The code is as digestible as Japanese mochi rice, a common cause of death by
    asphyxiation for toddlers, elderly people, and foreigners, like the author, in
    Japan. The structure is however simple, like the author as well. Everything depends
    on whether the floor/ceiling method is instantiated in the `rg` variable, or not.
    If floor/ceiling is present, then it supersedes everything else. If not, the other
    two methods (breakout and moving average crossover) are printed. The `ax1.fill_between`
    method identifies the boundaries. Read all of them to understand the conditions.
    The rest is uneventful:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE1]'
  prefs: []
  type: TYPE_PRE
- en: 'Now that this deadly code is out of the way, survivors may proceed to the next
    stage: range breakout.'
  prefs: []
  type: TYPE_NORMAL
- en: Breakout/breakdown
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: '"Kites rise highest against the wind—not with it."'
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
- en: – Winston Churchill
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
- en: This is the oldest and simplest trend-following method. It works for both bull
    and bear markets. If the price makes a new high over *x* number of periods, the
    regime is bullish. If the price makes a fresh low over *x* number of periods,
    the regime is bearish. This method is computationally easy to implement.
  prefs: []
  type: TYPE_NORMAL
- en: 'Popular durations are 252 trading days (which works out as 52 weeks), and 100
    and 50 trading days. Below, here is a simple rendition of this regime methodology:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE2]'
  prefs: []
  type: TYPE_PRE
- en: 'The way this code functions is simple:'
  prefs: []
  type: TYPE_NORMAL
- en: If the high is the highest of *x* periods, then `hl` is `1`.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Otherwise, if the low is the lowest of *x* periods, then `hl` is `-1`.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: If neither of these conditions is true, `hl` is N/A.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: We want to propagate the latest values forward along the missing values using
    the `fillna` method. First, we convert the `numpy` array to a `pandas` series.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Then, we fill missing values using the `fillna` forward fill method.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Download the data, run the function, and plot the chart:![](img/B17704_05_01.png)
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Figure 5.1: Softbank one year high/low regime breakout definition'
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: This range breakout strategy works wonders when the price breaks out after consolidation
    or a sideways market. Sideways markets are the interim periods between up or downward
    trends, when the old regime is dead and the new is not obvious yet. In a sideways
    undulating market, price oscillates in a range.
  prefs: []
  type: TYPE_NORMAL
- en: Bulls fight bears in a Gilgamesh epic battle. When prices break out from the
    upper or lower bound, this signals one side has thrown in the towel. Pent-up energy
    is released. The price moves effortlessly along the line of least resistance.
    This breakout method is therefore the weapon for choice for range breakouts/breakdowns.
  prefs: []
  type: TYPE_NORMAL
- en: The main drawback of this method is its built-in lag, which comes as a result
    of the duration. In financial revisionist jargon, the waiting period is called
    **confirmation**. Market participants rarely have the patience to wait 50 days,
    100 days, or even a year to finally find some resolution. Time is money. Stocks
    late on their rent should either be reduced or kicked out. Market participants
    that use this method with a long duration may want to re-introduce a time exit
    into their strategy.
  prefs: []
  type: TYPE_NORMAL
- en: 'The main advantages of this method are computational simplicity and stability.
    The major drawbacks are its inherent lag and the discomfort of giving back large
    amounts of profits. This leads us to the next iteration: the asymmetrical range
    breakout strategy.'
  prefs: []
  type: TYPE_NORMAL
- en: 'Further refinements to the breakout regime definition method include dissociated
    periods for entries and exits. For example, the legendary Chicago Turtle Traders
    entered on 50-day highs and closed on 20-day lows:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE3]'
  prefs: []
  type: TYPE_PRE
- en: 'This asymmetrical duration enables traders to capture small profits in nimble
    markets:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/B17704_05_02.png)'
  prefs: []
  type: TYPE_IMG
- en: 'Figure 5.2: Softbank with asymmetrical regime breakout duration (turtle traders
    for dummies)'
  prefs: []
  type: TYPE_NORMAL
- en: The preceding graph shows the closing price of Softbank, the slow regime breakout
    (orange solid line), the fast regime breakout (green dotted line), and the blue
    dashed-dotted line as the combination of both. The blue dashed-dotted line gives
    entries and exits. It is a bit difficult to read, so we will use a visually friendlier
    chart below.
  prefs: []
  type: TYPE_NORMAL
- en: 'The turtle strategy outlined above is a rudimentary script inspired by the
    legendary Turtle Traders. It is composed of two range breakout regimes. The slower
    duration is used for entries. The faster duration is used for exits. This asymmetrical
    duration for entry and exit relies on a time-honored principle: be prudent and
    deliberate to confirm trends, but quick and decisive to cut losses and protect
    profits. This last regime will be renamed *Turtle for dummies* from now on.'
  prefs: []
  type: TYPE_NORMAL
- en: We will be recycling this basic strategy throughout this book to illustrate
    examples, purely for educational purposes. However, do not do this at home— it
    is realistic enough for educational purposes, but too simplistic to be deployed
    in real-money production.
  prefs: []
  type: TYPE_NORMAL
- en: 'A more visual representation of the turtle for dummies strategies using `graph_regime_combo`
    is as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE4]'
  prefs: []
  type: TYPE_PRE
- en: 'This gives the chart below:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/B17704_05_03.png)'
  prefs: []
  type: TYPE_IMG
- en: 'Figure 5.3: Softbank regime using Turtle Trader methodology. The darker shade
    is the shorter timeframe'
  prefs: []
  type: TYPE_NORMAL
- en: The longer duration gives the direction; long or short. This is the blue line,
    based on the 50-day high/low. The shorter duration is the stop loss. We will discuss
    stop losses in detail in *Chapter 7*, *Improve Your Trading Edge*. Shorter duration
    protects profits by narrowing the range. The flipside of this is an elevated trading
    frequency. This set of parameters for the Turtle strategy does not work well in
    choppy markets as we can see throughout 2018\. It also struggles in sideways markets as
    in 2019.
  prefs: []
  type: TYPE_NORMAL
- en: Moving average crossover
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'Moving averages are another popular regime definition method. This method is so
    simple and prevalent that even the most hardcore fundamental analysts who claim
    never to look at charts still like to have a 200-day simple moving average. This
    method is also computationally easy. There may be further refinements as to the
    type of moving averages from simple to exponential, triangular, adaptive. Yet,
    the principle is the same. When the faster moving average is above the slower
    one, the regime is bullish. When it is below the slower one, the regime is bearish.
    The code below shows how to calculate the regime with two moving averages using
    simple and exponential moving averages (`SMA` and `EMA` respectively):'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE5]'
  prefs: []
  type: TYPE_PRE
- en: 'This produces the chart below:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/B17704_05_04.png)'
  prefs: []
  type: TYPE_IMG
- en: 'Figure 5.4: Softbank regimes using turtle breakout, SMA, and EMA'
  prefs: []
  type: TYPE_NORMAL
- en: 'Here, we compare three regime methods. We have our new freshly minted, best-friend-forever
    *Turtle for dummies* in the dashed-dotted blue line. We have the SMA in orange,
    and the EMA in the purple dashed line. The results are predictably close for the
    moving average series. The exponential moving average is more reactive than the
    simple one. We can now visualize the results using the `graph_regime_combo` chart
    function:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE6]'
  prefs: []
  type: TYPE_PRE
- en: 'The function accommodates up to three moving averages. To obtain a chart with
    only two moving averages, like has been done here, set the mid-term and long-term
    to the same values (in this instance, med-term and long-term have been set to
    `200`). Below is the resulting visual rendition of a moving average crossover
    regime. Areas in light green and light red are where the regime is either bullish
    or bearish and profitable. Areas in dark green and dark red are where the regime
    is either bullish or bearish and unprofitable:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/B17704_05_05.png)'
  prefs: []
  type: TYPE_IMG
- en: 'Figure 5.5: Crossover on Softbank darker zones are loss-making areas'
  prefs: []
  type: TYPE_NORMAL
- en: This strategy has a rough time in sideways and volatile markets. Fast- and slow-moving
    averages converge to a flat line with low amplitude sinusoidal oscillations. Trading
    frequency and loss rate increase while win rate collapses.
  prefs: []
  type: TYPE_NORMAL
- en: 'A more succinct way to instantiate the three moving averages is via a list
    comprehension. First, we create a list of moving average variables. Second, we instantiate
    variables through a comprehension list. Let''s write the above with a few list
    comprehensions:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE7]'
  prefs: []
  type: TYPE_PRE
- en: 'This would be something like this:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/B17704_05_06.png)'
  prefs: []
  type: TYPE_IMG
- en: 'Figure 5.6: Softbank crossover imposed on the Turtle for dummies'
  prefs: []
  type: TYPE_NORMAL
- en: This increasingly colorful chart shows the combination of two regime methods.
    It unfortunately adds more confusion than problems it solves. Market participants
    are sometimes tempted to add multiple conditions hoping to weed out false positives.
    But unfortunately it's easier to accept randomness than to try and eradicate it.
  prefs: []
  type: TYPE_NORMAL
- en: The two-line crossover is the most popular version of the moving crossover method.
    The slower line defines the regime while the shorter duration line times entries
    and exits. The most popular duration is 50/200, known as **golden/death cross**.
    In theory, this combination makes sense. 200 days is a robust long-term measure,
    while 50 days is a good momentum indicator. In practice, this combination has
    an awful hit rate. It only works for big long-term trends. Unfortunately, they
    come few and far between, hence the win rate hovering around 20%. The rest of
    the time the faster moving-average flip-flops back and forth around the slower
    one like a career politician.
  prefs: []
  type: TYPE_NORMAL
- en: These weaknesses lead moving-average aficionados to the next iteration of three
    moving averages. In the following example, we improve on the previous golden cross
    50/200 moving average crossover by adding another shorter-duration moving average.
    For the sake of simplicity, we use 20, 50, and 200 days. The 200 days gives the
    regime, while the 20/50 permutation gives entries and exits.
  prefs: []
  type: TYPE_NORMAL
- en: 'All we have to do is change one variable in the following code:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE8]'
  prefs: []
  type: TYPE_PRE
- en: 'We can see the resulting chart below:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/B17704_05_07.png)'
  prefs: []
  type: TYPE_IMG
- en: 'Figure 5.7: Softbank triple moving average crossover'
  prefs: []
  type: TYPE_NORMAL
- en: 'The longest duration determines the regime. The two medium- and short-term
    durations time entries and exits respectively. Rather than a long paragraph, the
    logic can best be summarized as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '**Long**: Enter and stay long as the short-term moving average is the highest,
    followed by the mid- and long-term moving averages'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '**Short**: Enter and stay short as long as the short-term moving average is
    below the mid-term, which in turn needs to be below long-term moving average.'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '**Else**: Neutral, no position.'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: This method is probably the most practical compromise between following long-term
    established trends and maintaining decent risk management.
  prefs: []
  type: TYPE_NORMAL
- en: Unlike the double-moving average graph we saw earlier, the triple-moving average
    does not persist in the wrong direction for long. It does a much better job at
    cutting positions early. Those are the colorless and shorter darker areas. The
    flip side is the increase in trading frequency. Another drawback is the inherent
    lag of this method. As evidenced in the middle portion of the chart, in sideways
    markets, price will move a fair bit in either direction before a signal is generated.
  prefs: []
  type: TYPE_NORMAL
- en: The main reason why market participants abandon the moving average method is
    sideways markets. When markets undulate sideways, moving averages oscillate around
    one another. This generates many false-positive signals, which tend to erode both
    the financial and the emotional capital bases. After a few costly false starts,
    market participants tend to look for less noisy methods.
  prefs: []
  type: TYPE_NORMAL
- en: Rather than tweaking moving-average durations or abandoning the method altogether,
    a better solution might be to play with bet size instead. Size smaller at the
    first sign of sideways markets and then increase weight as trends gain momentum.
  prefs: []
  type: TYPE_NORMAL
- en: Higher highs/higher lows
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'This is another popular method. Stocks that trend up make higher highs and
    higher lows. Conversely, stocks trending down make lower lows and lower highs
    in that order, and therefore suggest sustained weakness. This method makes intuitive
    sense. Unfortunately, it is not statistically as robust as it looks. Markets sometimes
    print lower/higher lows/highs that throw calculations off, before resuming their
    journey. Secondly, this method requires three conditions to be simultaneously
    met:'
  prefs: []
  type: TYPE_NORMAL
- en: A lower low.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: A lower high.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Both lower low and lower high conditions must be met sequentially, which only
    works in orderly markets.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Those three conditions have to be met consecutively in that precise order for
    the regime to turn bearish. Markets are random and noisier than people generally
    assume.
  prefs: []
  type: TYPE_NORMAL
- en: The main advantage of this method are entries and exits. On the long side, buy
    long on a low and exit on a high. On the short side, sell short on a high and
    exit on a low. Those counter-trend entries and exits enable market participants
    to capture profits. Furthermore, stop losses are objectively defined at the higher
    low on the long side and at the lower high on the short side.
  prefs: []
  type: TYPE_NORMAL
- en: Overall, the premise of this method makes logical sense. Stocks that print higher
    highs and higher lows are pulled upward, and vice versa on the way down. Unfortunately,
    this method struggles in noisy markets where there is no neat succession of highs
    and lows—I have therefore omitted the code from this chapter.
  prefs: []
  type: TYPE_NORMAL
- en: The following method uses the same swing highs and swing lows to define the regime
    in a much more powerful way. It is simple and statistically robust.
  prefs: []
  type: TYPE_NORMAL
- en: The floor/ceiling method
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'That method is originally a variation on the higher high/higher low method.
    Everyone has intuitively used it and yet it is so obvious that no-one has apparently
    bothered to formalise it. Unlike the higher high/higher low method, only one of
    the two following conditions has to be fulfilled for the regime to change:'
  prefs: []
  type: TYPE_NORMAL
- en: '**Bearish**: A swing high has to be materially lower than the peak.'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '**Bullish**: A swing low has to be materially higher than the bottom.'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: The swings do not even have to be consecutive for the regime to change. For
    example, markets sometimes shoot up, then retreat and print sideways swings for
    a while. Those periods are known as **consolidation**. The regime does not turn
    bearish until one swing high is markedly below the peak.
  prefs: []
  type: TYPE_NORMAL
- en: The classic definition is always valid regardless of the time frame and the
    asset class. Lows will be materially higher than the bottom in a bull market.
    Conversely, highs will be materially lower than the peak in bear markets.
  prefs: []
  type: TYPE_NORMAL
- en: 'Randomness triggers exceptions that are handled in a simple elegant way. There
    are two methods:'
  prefs: []
  type: TYPE_NORMAL
- en: '**Conservative**:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: If the regime is bearish and the price crosses over the ceiling, the regime
    turns bullish.
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: If the regime is bullish and the price crosses under the floor, the regime turns
    bearish.
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Aggressive**:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: If the regime is bearish and the price crosses over the discovery swing high,
    the regime turns bullish.
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: If the regime is bullish and the price crosses under the discovery swing low,
    the regime turns bearish.
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: 'This floor/ceiling method has only two regimes: bull or bear. A sideways regime
    is a pause within a broader bull or bear context. This method brings stability
    to regime definition. In practice, nothing is more frustrating than flip-flopping
    around a moving average. Stability enables market participants to better manage
    their positions.'
  prefs: []
  type: TYPE_NORMAL
- en: 'The floor/ceiling methodology is conceptually simple. It is however not easy
    to calculate. It is a two-step process:'
  prefs: []
  type: TYPE_NORMAL
- en: Swing detection
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Regime definition
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: The market does not go up in a straight line. It goes up and down along a dominant
    trend. It marks local highs and lows along the way. Those are called **swing highs**
    and **swing lows**.
  prefs: []
  type: TYPE_NORMAL
- en: Swing detection is 80% of the work in the floor/ceiling method. Not all swing
    highs and lows are born equal. The main difficulty is in separating noise from
    the signal. Since regime definition is based upon swings, faulty swing detection
    inevitably leads to faulty regime definition.
  prefs: []
  type: TYPE_NORMAL
- en: 'The logic of the code is simple. It relies on two tests: retest and distance.
    We will go through the entire sequence from swing high to swing low, which is
    illustrated in *Figure 5.8*:'
  prefs: []
  type: TYPE_NORMAL
- en: The price makes a new high from a previous swing low.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: The price drops from that all-time high.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: The price retests that all-time high, but it fails and drops below that post-high
    low.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Once the price closes below the highest low, sellers may be in charge. The algorithm
    is designed to continuously reset to the highest low after the all-time high.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'The following are the equivalent steps for a swing low:'
  prefs: []
  type: TYPE_NORMAL
- en: 'The price prints a lowest low: the first low.'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: It rebounds to a first high.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: The price retreats to its latest low, but fails to take the lowest low.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: The price subsequently starts traveling upward. Either it takes out the first
    high (always the highest high following the lowest low) or prints a lower high,
    called the latest high. When the price closes above the first or latest high,
    this suggests that buyers may be in charge now.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: This sequence repeats itself until the price closes above or below the latest
    high or low. In isolation, retests are not statistically significant. They occur
    quite frequently. When coupled with a distance test, retests tend to be more meaningful.
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '**Distance test**: This is the distance from the swing high to the lowest low.
    This test is either in units of volatility or percentage points. The further away
    from a swing, the more likely it indicates an exhaustion of the trend:![](img/B17704_05_08.png)'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Figure 5.8: Swing detection visual explanation: distance and retest'
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'Now, let''s zoom out and look at the big picture. The swing high in the above
    figure is the peak in the chart below:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/B17704_05_09.png)'
  prefs: []
  type: TYPE_IMG
- en: 'Figure 5.9: Floor/ceiling regime definition'
  prefs: []
  type: TYPE_NORMAL
- en: The line on the secondary axis is the regime. The regime turns bullish after
    finding a swing low substantially higher than the bottom. This swing low is now
    the regime change line. Should the price cross below that level, the regime will
    turn bearish. This happens in the first quarter of 2020, at which time the regime
    turns bearish. The price crosses above that level again and the regime reverts
    to bullish. The price prints an all-time high at the beginning of 2021, tanks,
    then rebounds, but rolls over before the high. The regime turns bearish. It is
    now time to switch side from the long to the short. Yet, the borrow on that issue
    was prohibitively expensive, so that juicy trade did not graduate to a round trip.
  prefs: []
  type: TYPE_NORMAL
- en: 'In the following sections, we will go through the source code required to calculate
    this. The conceptual framework was inspired by the seminal work of Belgian mathematician
    Benoit Mandelbrot on fractals. We start with a noisy series of small highs and
    lows and zoom out using the previous reduced series. This method is a bit more
    computationally intense than other methods. The result is however surprisingly
    intuitive. It broadly falls in two phases: **swing detection** and **regime definition**.
    Swing detection is a succession of small functions.'
  prefs: []
  type: TYPE_NORMAL
- en: Swing detection
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Swing detection splits in two parts: historical swings and last swing adjustment.
    The first two functions, `historical_swings` and `hilo_alternation`, accomplish
    90% of the work. The rest is a succession of small functions that ensure the last
    swing is relevant. This might look a little verbose at first sight, so we will
    slowly walk through all the functions and explain their relevance.'
  prefs: []
  type: TYPE_NORMAL
- en: Historical swings and high/low alternation
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'Let''s start with downloading historical prices. We are using using SPY, a
    proxy **Exchange-Traded Fund** (**ETF**) for the S&P 500, but you can experiment
    by using a different ticker if you like:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE9]'
  prefs: []
  type: TYPE_PRE
- en: 'Next, we will present each function sequentially and illustrate the progression
    with charts or attributes. We pick up where the previous function left off and
    march on. Finally, we will publish a full recap with all the functions at once
    and put out a chart:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE10]'
  prefs: []
  type: TYPE_PRE
- en: 'The `hilo_alternation` function loops through the reduction dataframe until
    the series is neatly constituted of alternating highs and lows. It eliminates:'
  prefs: []
  type: TYPE_NORMAL
- en: 'Same side consecutive highs and lows: highs are assigned a minus sign. lows
    have a positive sign. When there are two consecutive highs or lows, the lowest
    value marks the extreme point.'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Lows higher than surrounding highs. Randomness cannot be eliminated: in theory,
    this should not exist, but in practice, anomalies persist.'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Noisy short-distance highs and lows. The distance test is not entirely relevant
    as the alternation loop is contained within a larger multi-level loop. This is
    the fractal part of the algorithm where we look for the same pattern while zooming
    out. The feature is however an elegant option to shorten the number of loops.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: At the end of every iteration the `hilo df` is reduced using the `dropna` method.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'The `historical_swings` function takes the following steps:'
  prefs: []
  type: TYPE_NORMAL
- en: 'Reduction dataframe: Copy the main dataframe and instantiate a new series from
    high, low, and average values.'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Loop to reduce the dataframe.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Calculate two series of highs and lows (by assigning a minus sign to the average
    series). The only requirement for a high is that the preceding and succeeding
    bars must be lower and vice versa for troughs.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Run the `hilo_alternation` function to reduce the dataframe.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Populate the reduced dataframe and reduce further via the `dropna` method.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Populate the main dataframe for each level. Stop when the length of the reduction
    is <1% of the main dataframe, or no more reduction is possible, or 10 iterations
    have been passed.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'The above code returns this splendidly noisy chart:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/B17704_05_10.png)'
  prefs: []
  type: TYPE_IMG
- en: 'Figure 5.10: SPY fractal highs/lows level 1 to 3'
  prefs: []
  type: TYPE_NORMAL
- en: The first level is the small dots labeled Hi1 and Lo1 above and below the closing
    price. Level 2 is the red and green dots labeled Hi2 and Lo2\. It is less frequent,
    but still relatively noisy. Next, we really need to identify meaningful inflexions
    to base our analysis on. So, we go up one level. Triangles are level 3\. Prices
    have been filtered twice. The original dataframe has been reduced by 99%.
  prefs: []
  type: TYPE_NORMAL
- en: 'The following chart simply shows price and level 3 data:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/B17704_05_11.png)Figure 5.11: SPY historical swings'
  prefs: []
  type: TYPE_NORMAL
- en: 'The last triangle is below the highest close. This is clearly a false positive.
    The swing high is clearly neither the highest point, nor followed by a swing low.
    The rest of the functions will adjust for the last swing. So, let''s make this
    false positive disappear:'
  prefs: []
  type: TYPE_NORMAL
- en: '**Swing high**: The price continues to move higher than the latest swing high.'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '**Swing low**: The price continues to move lower than the latest swing low.'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'The `cleanup_latest_swing()` function removes false positives from the latest
    swing high and low:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE11]'
  prefs: []
  type: TYPE_PRE
- en: 'The code takes the following steps:'
  prefs: []
  type: TYPE_NORMAL
- en: The code identifies the latest swing low and high.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Identify the most recent swing.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: If a false positive, assign N/A.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'The following charts, before and after adjustment, demonstrate that the function
    has removed false positives from the data:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/B17704_05_12.png)'
  prefs: []
  type: TYPE_IMG
- en: 'Figure 5.12: SPY before: last swing high and low are false positives'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/B17704_05_13.png)'
  prefs: []
  type: TYPE_IMG
- en: 'Figure 5.13: SPY after: both swings are deleted'
  prefs: []
  type: TYPE_NORMAL
- en: 'The two charts are self-explanatory. The last two triangles have to be removed.
    The last swing low symbolized by a green triangle is higher than the preceding
    swing high. Besides, this swing high is invalid as there is no lower swing low.
    So, both are removed when we loop once over the last two swings. The chart now
    goes all the way back to the March 2020 low. Next, we will instantiate all the
    variables necessary for the rest of the process using the `latest_swing_variables()`
    function. This function calculates the variables that will be used in the next
    few functions. They are respectively:'
  prefs: []
  type: TYPE_NORMAL
- en: '`ud`: Direction, up `+1` , down `-1`.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`bs`: Base, either swing low or high.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`bs_dt`: The swing date.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`_rt`: The series name that will be used to detect swing. Either retest low,
    `rt_lo`, for a swing high, or retest high, `rt_hi`, for a swing low.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`_swg`: The series to assign the value; `shi` for swing high and `slo` for
    swing low.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`hh_ll`: Either the lowest low or highest high.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`hh_ll_dt`: The date of the highest high or lowest low.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'We will make use of list comprehension to declare variables:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE12]'
  prefs: []
  type: TYPE_PRE
- en: 'This will produce output like the following:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE13]'
  prefs: []
  type: TYPE_PRE
- en: The variables declared above will be used in the subsections to come.
  prefs: []
  type: TYPE_NORMAL
- en: Establishing trend exhaustion
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: Everything we have done up to this point is two-fold. We have detected historical
    swings and cleaned them up. Then, we have declared variables that we will be using
    to find the latest swing in real time. The method we use to detect the final swing
    is called a **retest**. In the context of the SPY chart, the market prints a highest
    high from the swing low. The price comes down a little then goes back up but fails
    to take the highest high. The price then penetrates the post-high low. Retests
    are essentially hesitations. They are quite frequent. Markets can and do remain
    indecisive more often than not. However, when retests happen at the end of a sustained
    move, this may signal an exhaustion of the trend and a possible reversal in the
    market direction.
  prefs: []
  type: TYPE_NORMAL
- en: 'This distance test acts as a filter. This function has two built-in tests:'
  prefs: []
  type: TYPE_NORMAL
- en: Distance expressed as a multiple of volatility. We use a measure of volatility
    **Average True Range** (**ATR**) or standard deviations.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Distance as a fixed percentage.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'The default setting of the function is no distance test, which will return
    a de facto pass. A successful test is either `-1` for a swing low or `+1` for
    a swing high, and `0` for a failed test. We will also define a function that calculates
    the ATR. This is classic volatility measure originally built by legendary Welles
    Wilder:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE14]'
  prefs: []
  type: TYPE_PRE
- en: 'This will produce the following output:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE15]'
  prefs: []
  type: TYPE_PRE
- en: This distance test verifies that between the latest swing to the most extreme
    price expressed either in units of volatility or in percentage points is big enough
    to suggest a potential trend exhaustion. This filter reduces the occurrence of
    false positives.
  prefs: []
  type: TYPE_NORMAL
- en: Retest swing
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
- en: 'All the functions led us to this moment: swing detection. This little function
    packs a surprisingly good punch. The logic is symmetrical for a swing high or
    low. We will therefore concentrate on a swing high:'
  prefs: []
  type: TYPE_NORMAL
- en: Detect the highest high from swing low.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: From the highest high, identify the highest retest low.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'When the price closes below the highest retest low: swing high = highest high.'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'It works just as well to identify swing lows. This is how the sequence would
    unfold:'
  prefs: []
  type: TYPE_NORMAL
- en: Detect the lowest low from the swing high.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: From the lowest low, identify the lowest retest high.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'When the price closes above the lowest retest high: swing low = lowest low.'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Note that the function will always reset to the highest retest low. Sometimes,
    price drops precipitously and then tries to regain some composure only to falter
    later. When resetting to the highest retest low, the function will waste no time
    identifying the earliest moment a trend has potentially reversed.
  prefs: []
  type: TYPE_NORMAL
- en: The function will also create series `rt` in absolute or `rrt` in relative to
    show which retest is used to detect swings. This optional feature may come useful
    if you want to visualize which retest was used to detect swings.
  prefs: []
  type: TYPE_NORMAL
- en: 'In *Figure 5.14*, this is the black dot:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE16]'
  prefs: []
  type: TYPE_PRE
- en: 'The black dot at the very end of the resulting chart is the highest retest
    low. Note that this will periodically disappear as the function resets when it
    meets either a new high or new low, so don''t worry if it isn''t visible when
    you run the function:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/B17704_05_14.png)'
  prefs: []
  type: TYPE_IMG
- en: 'Figure 5.14: Retest from a swing low'
  prefs: []
  type: TYPE_NORMAL
- en: As long as the price keeps making new highs, the retest resets along the way.
    There will be false positives along the way, but this is part of the journey.
  prefs: []
  type: TYPE_NORMAL
- en: Some readers may not agree with the retest method, whatever the reasons might
    be. So, we introduce an alternative method of swing detection.
  prefs: []
  type: TYPE_NORMAL
- en: Retracement swing
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
- en: 'This function is an alternative to the retest method. It relies solely on a
    retracement from the extreme value. The main benefit of this method is its conceptual
    simplicity. Once the price has moved far enough in the opposite direction, then
    it is usually safe to conclude that a swing has been printed. This instrument
    is blunt, however. It usually works but fails in sideways or highly volatile markets:'
  prefs: []
  type: TYPE_NORMAL
- en: Calculate the retracement from the extreme value, either the minimum from the
    top or the maximum from the bottom.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Distance test in units of volatility or in percentage points.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'This function acts as a failsafe in case a retest does not materialize quickly
    enough:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE17]'
  prefs: []
  type: TYPE_PRE
- en: 'This creates the following graphs:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/B17704_05_15.png)'
  prefs: []
  type: TYPE_IMG
- en: 'Figure 5.15: Retracement swing function levels 2 and 3'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/B17704_05_16.png)'
  prefs: []
  type: TYPE_IMG
- en: 'Figure 5.16: Retracement swing function swing highs and lows'
  prefs: []
  type: TYPE_NORMAL
- en: This final function acts as a failsafe when markets move brutally one way or
    another. Both functions (retest and retracement) can be used concurrently.
  prefs: []
  type: TYPE_NORMAL
- en: So, we went through all this verbose code to come up with a few meaningful datapoints
    called **swing highs** and **lows**. Next, we will use those swings as a basis
    for regime detection.
  prefs: []
  type: TYPE_NORMAL
- en: 'Putting it all together: regime detection'
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: Let's do a quick recap using all the functions. To demonstrate the versatility
    of the functions, we will spice things a little. First, we publish the code for
    the relative function again. Then we will run SPY in absolute, then benchmark
    it against ONEQ (a proxy ETF for Nasdaq).
  prefs: []
  type: TYPE_NORMAL
- en: 'We will plot three charts to show where your money is best allocated:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE18]'
  prefs: []
  type: TYPE_PRE
- en: 'Let''s run through the key steps covered by this code:'
  prefs: []
  type: TYPE_NORMAL
- en: We instantiate the benchmark `ONEQ`. The currency is `USD`.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: We instantiate `df` by copying the raw data. We run two list comprehensions
    to declare the variables.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: We run the relative function to get the relative prices.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: The `for` loop will run once over the absolute series. At the end of the first
    run, we run two list comprehensions to declare the relative variables.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: In the second loop, the absolute variables are replaced with relative ones.
    Everything is symmetrical. The parameters remain the same. The only things that
    have changed are the input series.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Finally, we print four charts:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE19]'
  prefs: []
  type: TYPE_PRE
- en: 'The first one is the Christmas tree-looking chart with all the small dots:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/B17704_05_17.png)'
  prefs: []
  type: TYPE_IMG
- en: 'Figure 5.17: SPY with highs/lows level 1 to 3'
  prefs: []
  type: TYPE_NORMAL
- en: 'All the information is present. The chart is noisy. The second one is a clean
    **SPY** chart:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/B17704_05_18.png)'
  prefs: []
  type: TYPE_IMG
- en: 'Figure 5.18: SPY with swing highs and lows'
  prefs: []
  type: TYPE_NORMAL
- en: 'This is a clean chart of **SPY**. The false positives have been removed. And
    now for the grand finale; **SPY** versus **ONEQ**:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/B17704_05_19.png)'
  prefs: []
  type: TYPE_IMG
- en: 'Figure 5.19: SPY in absolute and relative to ONEQ'
  prefs: []
  type: TYPE_NORMAL
- en: '**SPY** has clearly underperformed **ONEQ**, meaning the S&P 500 has underperformed
    the Nasdaq for a few years straight. Swings in relative value tend to mirror the
    absolute ones. Interestingly enough, looking at the fourth and final chart, it
    seems like the relative value may have bottomed out, meaning the last swing low
    seems to be substantially higher than the lowest low:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/B17704_05_20.png)'
  prefs: []
  type: TYPE_IMG
- en: 'Figure 5.20: Has SPY finally bottomed out versus ONEQ?'
  prefs: []
  type: TYPE_NORMAL
- en: When we print the relative chart, it seems like the last swing low may be substantially
    higher than the lowest low. This means the relative chart may have bottomed out.
    This could be an early indication that the S&P 500 might start to outperform the
    Nasdaq. This neatly leads us into the next section on floor/ceiling regime definition.
  prefs: []
  type: TYPE_NORMAL
- en: Regime definition
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: A bear market ends when new lows are materially higher than the lowest low.
    At some point, the market will print a bottom. Every subsequent low will settle
    higher. Measure all lows versus the bottom. Once the distance expressed in volatility-adjusted
    units or even percentage points is wide enough, the market has found a floor.
    In execution trader English, if all the pessimism of the sellers fails to penetrate
    the low, then the market is no longer bearish.
  prefs: []
  type: TYPE_NORMAL
- en: A bull market ends when all advances retreat below the top. At some point, the
    market will print a top. If every subsequent rally settles below the top, the
    market has found a ceiling. In execution trader English, if all the bullishness
    cannot take the high, then this bull is over. When a ceiling is found, the market
    can turn either sideways or bearish. Conversely, when a floor is found, the market
    can turn either sideways or bullish.
  prefs: []
  type: TYPE_NORMAL
- en: The formula is a **z-score** of the distance from peak/trough to subsequent
    swing highs/lows. The z-score is a delta expressed in units of volatility (ATR,
    standard deviations, realized or implied). The code below may look a bit verbose.
    The principle is however conceptually simple.
  prefs: []
  type: TYPE_NORMAL
- en: 'A classic bull regime is defined as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: 'Look for a ceiling: The search window starts from the floor.'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Measure the current swing versus the ceiling: `ceiling_test = (swing_high[i]-top)/stdev[i]`.'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: If the distance to the ceiling is fewer than *x* standard deviations, the regime
    has turned bearish.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'A classic bear regime is defined as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: 'Look for a floor: The search window starts from the ceiling.'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Measure the current swing versus the floor: `floor_test = (swing_low[i]-bottom)/stdev[i]`.'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: If the distance to the floor is greater than *x* standard deviations, the regime
    has turned bullish.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'The code for the floor/ceiling function is this chapter''s *pièce de résistance*.
    The function is as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE20]'
  prefs: []
  type: TYPE_PRE
- en: 'Behind this intimidatingly verbose code is simple logic. Let''s go through
    its main articulations. There are broadly two logics:'
  prefs: []
  type: TYPE_NORMAL
- en: '**Classic floor and ceiling discovery**: We loop through the swings to identify
    peaks and subsequent falling swing highs as well as bottoms and rising swing lows.
    This type of setup is referred to as classic floor and ceiling discovery inside
    the code.'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '**Exception handling**: This happens when price penetrates discovery swings:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Initial penetration: For a floor, we look for the lowest low since the discovery
    swing low. For a ceiling, we look for the highest high since the discovery swing
    high. The regime is reset to the previously dominant one.'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Reversion: Sometimes prices bounce around. This roundtrip exception handling
    ensures the regime responds well to randomness.'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Once the loop is over, columns are populated.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'After those clarifications, voila! The floor/ceiling regime is the dashed horizontal
    line on the secondary *y* axis. This regime methodology is the definition of stability:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/B17704_05_21.png)'
  prefs: []
  type: TYPE_IMG
- en: 'Figure 5.21: SPY close and floor/ceiling bullish regime'
  prefs: []
  type: TYPE_NORMAL
- en: The regime has remained bullish throughout the entire period. The market "hit
    a soft patch," financial creole for puking its guts out, in early 2020\. The regime
    did not even blink. This does not mean this regime definition is not responsive.
    It does not mean that market participants should "buy and hope." It simply means
    the regime did not change. This stability allows market participants to articulate
    strategies and manage risk in a calm, composed manner.
  prefs: []
  type: TYPE_NORMAL
- en: Methodology comparison
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: '"Learning to choose is hard. Learning to choose well is harder. And learning
    to choose well in a world of unlimited possibilities is harder still."'
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
- en: – Barry Schwartz on the paradox of choice
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
- en: In 2004, Barry Schwartz rocked the world with something we have always intuitively
    felt. The more choices we have, the more stress we experience. We have outlined
    a few methods. Let's compare them graphically and hope the winner will visually
    stand out.
  prefs: []
  type: TYPE_NORMAL
- en: 'Firstly, let''s print the floor/ceiling alone. The small dots are level 1\.
    The big dots are level 2\. The black triangle is the floor. The shade is the length
    of the regime. It starts from the first swing low and goes all the way to the
    right. Even the pandemic "soft patch" did not put a dent in it. This is as stable
    as it possibly can be:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/B17704_05_22.png)'
  prefs: []
  type: TYPE_IMG
- en: 'Figure 5.22: SPY floor/ceiling bullish regime forever'
  prefs: []
  type: TYPE_NORMAL
- en: This could come across as unresponsive to market gyrations and to a certain
    extent it is. In Q1 of 2020, the world seemed to bound for AC/DC's proverbial
    "highway to hell" in a hand basket. And yet, the regime was not swayed. It probably
    flashed bearishly on the ascent in late May 2020, but promptly reverted back to
    a Robert de Niro "raging bull" market. It is neither good nor bad. It is simply
    how this regime method works. The vast majority of market participants are long-term
    trend followers. They want to buy stuff to pass on to future generations along
    with their Philippe Patek watch collection.
  prefs: []
  type: TYPE_NORMAL
- en: It does not mean that they will do nothing for the next decade. Market participants
    often add to their positions as markets tank, something known as **buy on weakness**.
    This is the perfect regime definition method to accomplish this. The unparalleled
    stability of this regime detection methodology sets the long-term background context.
    The regime is either bullish or bearish. Then, market participants can superimpose
    all kinds of strategies to either "buy on weakness" or "sell on strength" depending
    on the dominant regime.
  prefs: []
  type: TYPE_NORMAL
- en: More importantly, Warren Buffett said that we should buy when there is blood
    on the streets. Easier said than done when the market has dropped like a stone
    and our limbic brain feels trapped. This is where this regime method brings the
    reassurance needed to pull the trigger.
  prefs: []
  type: TYPE_NORMAL
- en: 'Secondly, we print out the moving average and range breakout regime methodologies:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE21]'
  prefs: []
  type: TYPE_PRE
- en: 'This will produce the following two charts:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/B17704_05_23.png)'
  prefs: []
  type: TYPE_IMG
- en: 'Figure 5.23: SPY regime breakout and moving average crossover'
  prefs: []
  type: TYPE_NORMAL
- en: Variables are deliberately much longer than the patience of the average market
    participant. The range breakout is set at 252 days breakout and 50 days stop loss.
    The triple moving average has the famous golden cross and 20 days as entry/exit.
    Those variables deliberately calibrate for long-term trends. They are not supposed
    to flip-flop like a senator. And yet, there are still a few changes along the
    way.
  prefs: []
  type: TYPE_NORMAL
- en: 'The second chart overlays the floor/ceiling method. This is the lightest shade
    of blue that stretches from the first swing to the end of the chart:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/B17704_05_24.png)'
  prefs: []
  type: TYPE_IMG
- en: 'Figure 5.24: SPY floor/ceiling, breakout, and moving average crossover regimes'
  prefs: []
  type: TYPE_NORMAL
- en: The above chart combines all three methods in one crisp visualization. The floor/ceiling
    is the lightest shade of blue. Note that the floor/ceiling regime supersedes all
    other methodologies. Bearish phases using the breakout or moving average crossover
    methodologies are not reflected unless the floor/ceiling regime changes.
  prefs: []
  type: TYPE_NORMAL
- en: The big takeaway is that the floor/ceiling method provides stability upon which
    to build strategies. There is tremendous value in knowing that the market is still
    bullish and dips should be bought. No other method out there provides this level
    of stability. Institutional investors move big tickets. Getting in and out erodes
    profitability. This is why they will privilege from stability over accuracy. When
    conditions change, they change their mind. Until then, this is usual drama. Market
    participants can then articulate strategies however they see fit. It could be
    swing detection, moving averages, range breakout, or risk reversal. The only thing
    that matters is the knowledge that the market is still in bullish territory.
  prefs: []
  type: TYPE_NORMAL
- en: For market participants who favor action over patience, there are two ways to
    overclock the floor/ceiling methodology. It relies on swings. Increase the number
    of swings and the regime will mechanically be more nervous.
  prefs: []
  type: TYPE_NORMAL
- en: '**Method 1**: Use level 2 instead of level 3 swings. Level 3 filters out a
    lot of noise. This also makes it less responsive. If you do not mind the noise,
    go ahead'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Method 2**: Faster periodicity. This data was processed on daily bar timeframe.
    Keep the same level 3 but accelerate the periodicity to a 4 hour interval. This
    second method gives some fascinating results. Try downloading data at a 1-5 minute
    interval. Process the swing detection sequence and watch the fractals paint a
    near perfect picture up to daily frame. Warning: this method works well for historical
    data, but generates numerous false positives. As such, we did not generate the
    data to promote the method.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'The above ticker is a example on the long side. It looks a bit incongruous
    in a book on short selling. Yet, the message is easier to convey to market participants
    coming from the long side. This methodology is rigorously symmetrical on the short
    side. It is therefore time to revisit our beloved scandalous Wells Fargo example.
    We will run the sequence in both absolute and relative to the S&P500 and publish
    the respective charts:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE22]'
  prefs: []
  type: TYPE_PRE
- en: 'This will generate a graph like the following:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/B17704_05_25.png)'
  prefs: []
  type: TYPE_IMG
- en: 'Figure 5.25: Wells Fargo in absolute and relative to the S&P 500'
  prefs: []
  type: TYPE_NORMAL
- en: The above code is a repeat of something we already saw in a previous chapter.
    Next, we will run the sequence. One thing worth noting is that the calculation
    regarding the benchmark and currency precedes the single stock calculation. Should
    you want to run the same calculation across an entire investment universe, all
    you have to do is insert a loop to iterate tickers.
  prefs: []
  type: TYPE_NORMAL
- en: 'Next, we run the swing detection and regime definition twice. First, we run
    it on the absolute series. At the end of the loop, we re-initialize the variables
    to the relative series. And then we run the sequence on the relative series:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE23]'
  prefs: []
  type: TYPE_PRE
- en: 'We explained all these functions previously. Now, the sequence is packaged
    in one block of code. In the appendix, we will re-package this a bit more elegantly
    with a single function. Finally, we print colorful charts to represent the regimes
    both in absolute and relative:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE24]'
  prefs: []
  type: TYPE_PRE
- en: 'All other parameters have been muted. The code will print two charts. We only
    want to look at the floor/ceiling regimes in absolute and relative. First, we
    will print the absolute series:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/B17704_05_26.png)'
  prefs: []
  type: TYPE_IMG
- en: 'Figure 5.26: Wells Fargo floor/ceiling regime in absolute'
  prefs: []
  type: TYPE_NORMAL
- en: 'This chart is a great example because it shows this regime is not a panacea.
    The floor/ceiling methodology is not a universal cure for randomness. There are
    loss-making periods on the long side. This simply means that regime definition
    is not a substitute for risk management. Next, we print Wells Fargo relative to
    the S&P500:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/B17704_05_27.png)'
  prefs: []
  type: TYPE_IMG
- en: 'Figure 5.27: Wells Fargo floor/ceiling regime relative to the S&P 500'
  prefs: []
  type: TYPE_NORMAL
- en: Again, Wells Fargo is not a perennial underperformer. It has its fleeting moments
    of glorious "rise and shine" in the sunset before slipping back into a long descent.
    As the last swing low suggests, the regime might even have turned bullish. Maybe
    this time around, outperformance may be more sustainable.
  prefs: []
  type: TYPE_NORMAL
- en: Timing the optimal entry point after the bottom or the peak
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: '"Far more money has been lost by investors preparing for corrections, or trying
    to anticipate corrections, than has been lost in corrections themselves."'
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
- en: – Peter Lynch
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
- en: The first problem is market participants who want to protect their gains by
    anticipating regime change tend to lose money in the long run. If some "expert"
    walked up to you and said, "you will fall sick next week. You will be ill for
    an average of three months. You will be cured on this precise day," you would
    probably think they had lost their L-size tin-foil hat!
  prefs: []
  type: TYPE_NORMAL
- en: Yet, in the markets, we pay attention to this constant chrematocoulrophony (remember
    our keyword from *Chapter 2*, *10 Classic Myths about Short Selling*). Market
    gurus are excellent at timing tops and bottoms. In fact, they impeccably timed
    the last 2 bear markets 39 times in a row! However, predicting tops and bottoms
    is a fool's game. There are thousands of days between the day of the bottom and
    the peak. You can afford to miss the first 50 days and still catch the big move.
    The floor/ceiling method will not get you out at the peak. It will get you into
    a short position at the highest point possible with reasonable accuracy.
  prefs: []
  type: TYPE_NORMAL
- en: Seeing through the fundamental news flow
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'The second problem comes when the fundamental news flow catches up with the
    tape. Fundamental information looks strong around the top and weak around the
    bottom of the market. It reports past numbers, such as monthly sales, orders,
    and so on. Meanwhile, markets tend to look forward. Market participants fall prey
    to "confirmation bias": they have all the fundamental evidence they need to double-up
    their positions or throw in the towel.'
  prefs: []
  type: TYPE_NORMAL
- en: This floor and ceiling method is an objective way to assess whether it is time
    to remain bullish or take a more defensive stance. This method has several advantages.
    First, stability brings reliability. For example, the regime for the S&P 500 switched
    from bull to sideways-bearish only twice in the ten plus years following the 2008
    crisis. Each time, the regime reverted to bullish less than 3 months thereafter.
  prefs: []
  type: TYPE_NORMAL
- en: Compare this with the 20+ times when the price at close flip-flopped around
    the 200-day moving average. That level of stability brings superior confidence
    to market participants. Until the regime changes, every pullback is an opportunity
    to buy.
  prefs: []
  type: TYPE_NORMAL
- en: 'This method also brings clarity. It saves us from our rationalizing stupidity.
    At some point, we have all come across a stock where we thought: "This has gone
    up too much, time to short." Well, this tends to happen to stocks in a bull regime.
    Or, we might utter: "This has fallen way too much, time to buy." That also tends
    to happen to bearish stocks. The regime brings clarity: buy bull and hedge, sell
    bear and hedge.'
  prefs: []
  type: TYPE_NORMAL
- en: Recognizing turning points
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: The strength of the floor/ceiling method comes around turning points. We grew
    up thinking that a bull needs to die for a bear to start and vice versa. With
    this method, bear markets start within dying bull markets and vice versa. The
    nuance is expensive. It allows market participants to position themselves as one
    regime transitions to the next.
  prefs: []
  type: TYPE_NORMAL
- en: Euphoric market participants often remain bulled up past the peak and depressed
    past the bottom. In the screaming match between our left and right earlobes, we
    often fail to listen to what the market quietly whispers.
  prefs: []
  type: TYPE_NORMAL
- en: The hardest thing to determine is when to liquidate a profitable position. This
    method is robust enough to keep Ulysses tied to the mast of reason while he sails
    past the sirens of the markets. The good news is that this method is logically
    accurate. Bear markets start when new advances retreat below the ceilings. Bull
    markets start when new lows remain above the floor.
  prefs: []
  type: TYPE_NORMAL
- en: Let the market regime dictate the best strategy
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: '"When you have eliminated all which is impossible, then whatever remains, however
    improbable, must be the truth."'
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
- en: – Sir Arthur Conan Doyle
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
- en: Over the years, I have come to believe that the two primary determinants of
    performance are position sizing and market regime. Trade too big and you could
    be out of business. Trade too small and you do not have a business. Secondly,
    seasoned market participants usually have several strategies to cope with different
    market types.
  prefs: []
  type: TYPE_NORMAL
- en: The difficulty is which strategy to use when and more importantly when to fade
    them. This comes down to regime definition. The floor/ceiling method could potentially
    change the way you trade markets.
  prefs: []
  type: TYPE_NORMAL
- en: 'There are two types of strategy: mean reversion and trend following. Mean reversion
    works best in range-bound markets. The price oscillates around a mean in a semi-predictable
    fashion. Mean reversion strategies perform poorly in trending markets. Trend-following
    strategies work well in bull or bear markets but end up giving back their gains
    in sideways markets.'
  prefs: []
  type: TYPE_NORMAL
- en: At the end of a bull run, when a ceiling is found, the market can either go
    sideways or bear. All the summer bulls are not going to wake up with their winter
    bear clothes on the same day. Assume the market will be sideways, until it dawns
    upon the "golden traders" (laggards whose intellectual density is thicker than
    gold) that the bears are in charge. Conversely, when a floor is found, it will
    take time to process the traumatic experience of the bear market and be positioned
    for a nascent bull market.
  prefs: []
  type: TYPE_NORMAL
- en: Once a floor or a ceiling is found, assume that markets go sideways, or trade
    in a range, until there is evidence it goes bearish or resumes its bull trend.
    Pause trend trading and step into mean reversion. Once there is evidence a new
    trend has emerged, and the market makes lower highs/higher lows or breaks out
    of the range, re-activate trend trading and pause mean reversion.
  prefs: []
  type: TYPE_NORMAL
- en: 'Symmetry is usually a foreign concept to market participants coming from the
    long-only side. Market participants all start with the ideal of symmetry but quickly
    realise that their long-side rules do not work well on the short side. After all,
    the long side is slow moving and generally quiet while the short side is fast
    paced and volatile. They then proceed to develop two sets of rules to contend
    with each side separately. As usual, it all works well in theory until it needs
    to work in practice. Problems arise when both rules are simultaneously valid,
    and stocks could be either long or short. This usually happens at the worst time:
    when performance starts to suffer. Dwindling performance is not conducive to clarity.
    At this point, market participants resort to conviction, stories, or complicated
    risk management. Symmetry avoids conflicting rules. It is either a long or short,
    never both.'
  prefs: []
  type: TYPE_NORMAL
- en: 'Let the market regime dictate the strategy. The floor/ceiling method gives
    an objective start and ending point for each of those regime changes: ceiling,
    range, and floor. Once you know if the broader regime should be bullish, bearish,
    or sideways, it is easier to design strategies that fit into each bucket. With
    proper regime definition and position sizing, even a mediocre strategy can have
    a positive edge.'
  prefs: []
  type: TYPE_NORMAL
- en: Summary
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: We have examined a few regime methodologies that will help you pick up on signals
    that a market is going up or down. Regime breakouts and moving average crossovers
    are staples in the arsenal of trend-following traders. Duration is as much a function
    of style as what the market happens to reward. Then, we introduced the floor/ceiling
    methodology. This regime definition method works on absolute and relative series.
    It is symmetrical and above all more stable than any other methodology. It therefore
    supersedes everything else.
  prefs: []
  type: TYPE_NORMAL
- en: However, regime definition methodologies are not mutually exclusive. For example,
    the floor/ceiling method could be used to determine the direction of trades, long
    or short. Then, regime breakout could be used to enter after consolidation or
    sideways markets. Finally, the moving average crossover could be used to exit
    positions.
  prefs: []
  type: TYPE_NORMAL
- en: 'Having a signal is one thing. Turning it into a profitable strategy with a
    robust statistical edge is another. There is no profitable equivalent the "buy-and-hold"
    mentality on the short side. Short selling is like mixed martial arts. That belt
    will claim its pound of flesh. For this reason, we will spend the rest of *Part
    II, The Outer Game: Developing a Robust Trading Edge* working on how to do just
    that; build a robust trading edge.'
  prefs: []
  type: TYPE_NORMAL
