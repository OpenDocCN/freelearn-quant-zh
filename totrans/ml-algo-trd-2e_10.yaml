- en: '10'
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: '10'
- en: Bayesian ML – Dynamic Sharpe Ratios and Pairs Trading
  id: totrans-1
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 贝叶斯 ML – 动态夏普比率和对冲交易
- en: In this chapter, we will introduce Bayesian approaches to **machine learning**
    (**ML**) and how their different perspective on uncertainty adds value when developing
    and evaluating trading strategies.
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章中，我们将介绍贝叶斯方法在**机器学习**（**ML**）中的应用以及它们在开发和评估交易策略时对不确定性的不同视角所带来的价值。
- en: Bayesian statistics allows us to quantify uncertainty about future events and
    refine our estimates in a principled way as new information arrives. This dynamic
    approach adapts well to the evolving nature of financial markets. It is particularly
    useful when there are fewer relevant data and we require methods that systematically
    integrate prior knowledge or assumptions.
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
  zh: 贝叶斯统计学允许我们量化对未来事件的不确定性，并以原则性的方式在新信息到达时改进我们的估计。这种动态方法在金融市场的演变性质下适应良好。当相关数据较少且我们需要系统地整合先前知识或假设时，它特别有用。
- en: We will see that Bayesian approaches to machine learning allow for richer insights
    into the uncertainty around statistical metrics, parameter estimates, and predictions.
    The applications range from more granular risk management to dynamic updates of
    predictive models that incorporate changes in the market environment. The Black-Litterman
    approach to asset allocation (see *Chapter 5*, *Portfolio Optimization and Performance
    Evaluation*) can be interpreted as a Bayesian model. It computes the expected
    return of an asset as an average of the market equilibrium and the investor's
    views, weighted by each asset's volatility, cross-asset correlations, and the confidence
    in each forecast.
  id: totrans-4
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将看到，贝叶斯方法对机器学习的应用允许更丰富地了解统计指标、参数估计和预测周围的不确定性。这些应用范围从更精细的风险管理到动态更新预测模型，其中包括市场环境的变化。资产配置的黑-利特曼方法（参见*第5章*，*组合优化和绩效评估*）可以被解释为贝叶斯模型。它计算资产的预期回报作为市场均衡和投资者观点的加权平均值，每个资产的波动性，跨资产相关性和对每个预测的信心。
- en: 'More specifically, in this chapter, we will cover:'
  id: totrans-5
  prefs: []
  type: TYPE_NORMAL
  zh: 更具体地说，在本章中，我们将涵盖：
- en: How Bayesian statistics apply to ML
  id: totrans-6
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 贝叶斯统计学如何应用于 ML
- en: Probabilistic programming with PyMC3
  id: totrans-7
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用 PyMC3 进行概率编程
- en: Defining and training ML models using PyMC3
  id: totrans-8
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用 PyMC3 定义和训练 ML 模型
- en: How to run state-of-the-art sampling methods to conduct approximate inference
  id: totrans-9
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 如何运行最先进的抽样方法进行近似推理
- en: Bayesian ML applications to compute dynamic Sharpe ratios, dynamic pairs trading
    hedge ratios, and estimate stochastic volatility
  id: totrans-10
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 贝叶斯 ML 应用于计算动态夏普比率、动态对冲交易对冲比率和估计随机波动性
- en: You can find the code samples for this chapter and links to additional resources
    in the corresponding directory of the GitHub repository. The notebooks include
    color versions of the images.
  id: totrans-11
  prefs: []
  type: TYPE_NORMAL
  zh: 您可以在 GitHub 存储库的相应目录中找到本章的代码示例和附加资源的链接。笔记本包括图像的彩色版本。
- en: How Bayesian machine learning works
  id: totrans-12
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 贝叶斯机器学习的工作原理
- en: '**Classical statistics** is said to follow the frequentist approach because
    it interprets probability as the relative frequency of an event over the long
    run, that is, after observing a large number of trials. In the context of probabilities,
    an event is a combination of one or more elementary outcomes of an experiment,
    such as any of six equal results in rolls of two dice or an asset price dropping
    by 10 percent or more on a given day).'
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
  zh: '**经典统计学**被认为遵循频率主义方法，因为它将概率解释为长期观察大量试验后事件发生的相对频率。在概率的背景下，事件是一个或多个试验的基本结果的组合，例如掷两个骰子的六个等可能结果中的任何一个，或者在某一天资产价格下跌了10%或更多。'
- en: '**Bayesian statistics**, in contrast, views probability as a measure of the
    confidence or belief in the occurrence of an event. The Bayesian perspective,
    thus, leaves more room for subjective views and differences in opinions than the
    frequentist interpretation. This difference is most striking for events that do
    not happen often enough to arrive at an objective measure of long-term frequency.'
  id: totrans-14
  prefs: []
  type: TYPE_NORMAL
  zh: 相比之下，**贝叶斯统计学**将概率视为事件发生的信心或信念的度量。因此，贝叶斯观点为主观看法和意见差留下了更多的空间，而不是频率主义解释。这种差异在那些不经常发生以至于无法得出长期频率客观度量的事件中最为显著。
- en: Put differently, frequentist statistics assumes that data is a random sample
    from a population and aims to identify the fixed parameters that generated the
    data. Bayesian statistics, in turn, takes the data as given and considers the
    parameters to be random variables with a distribution that can be inferred from
    data. As a result, frequentist approaches require at least as many data points
    as there are parameters to be estimated. Bayesian approaches, on the other hand,
    are compatible with smaller datasets, and well suited for online learning from
    one sample at a time.
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
  zh: 换句话说，频率统计假设数据是从总体中随机抽样的，并旨在识别生成数据的固定参数。贝叶斯统计则将数据视为给定，并认为参数是随数据可推断的随机变量的分布。因此，频率主义方法至少需要与要估计的参数数量相同数量的数据点。另一方面，贝叶斯方法适用于较小的数据集，并且非常适合从一次一个样本进行在线学习。
- en: The Bayesian view is very useful for many real-world events that are rare or
    unique, at least in important respects. Examples include the outcome of the next
    election or the question of whether the markets will crash within 3 months. In
    each case, there is both relevant historical data as well as unique circumstances
    that unfold as the event approaches.
  id: totrans-16
  prefs: []
  type: TYPE_NORMAL
  zh: 贝叶斯观点对于许多在某些重要方面罕见或独特的现实事件非常有用。例如，下次选举的结果或者市场是否会在3个月内崩溃的问题。在每种情况下，都有相关的历史数据以及随着事件逼近而展开的独特环境。
- en: 'We will first introduce Bayes'' theorem, which crystallizes the concept of
    updating beliefs by combining prior assumptions with new empirical evidence, and
    compare the resulting parameter estimates with their frequentist counterparts.
    We will then demonstrate two approaches to Bayesian statistical inference, namely
    conjugate priors and approximate inference, which produce insights into the posterior
    distribution of latent (that is, unobserved) parameters, such as the expected
    value:'
  id: totrans-17
  prefs: []
  type: TYPE_NORMAL
  zh: 我们首先会介绍贝叶斯定理，该定理通过将先验假设与新的经验证据相结合来阐明通过更新信念的概念，并将结果参数估计与其频率论对应物进行比较。然后我们将展示两种贝叶斯统计推断方法，即共轭先验和近似推断，这些方法揭示了潜在参数（即未观察到的参数）的后验分布，如期望值：
- en: '**Conjugate priors** facilitate the updating process by providing a closed-form
    solution that allows us to precisely compute the solution. However, such exact,
    analytical methods are not always available.'
  id: totrans-18
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**共轭先验** 通过提供闭合形式的解决方案来促进更新过程，从而使我们能够精确计算解决方案。然而，这种精确的分析方法并不总是可用。'
- en: '**Approximate inference** simulates the distribution that results from combining
    assumptions and data and uses samples from this distribution to compute statistical insights.'
  id: totrans-19
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**近似推断** 模拟由假设和数据结合而成的分布，并使用该分布的样本来计算统计洞见。'
- en: How to update assumptions from empirical evidence
  id: totrans-20
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 如何从经验证据中更新假设
- en: '"When the facts change, I change my mind. What do you do, sir?"'
  id: totrans-21
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
  zh: '"当事实改变时，我改变我的想法。您怎么做，先生？"'
- en: ''
  id: totrans-22
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
- en: –John Maynard Keynes
  id: totrans-23
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
  zh: –约翰·梅纳德·凯恩斯
- en: The theorem that Reverend Thomas Bayes came up with, over 250 years ago, uses
    fundamental probability theory to prescribe how probabilities or beliefs should
    change as relevant new information arrives. The preceding Keynes quotation captures
    that spirit. It relies on the conditional and total probability and the chain
    rule; see Bishop (2006) and Gelman et al. (2013) for an introduction and more.
  id: totrans-24
  prefs: []
  type: TYPE_NORMAL
  zh: 250多年前，托马斯·贝叶斯牧师提出的定理使用基本的概率理论来规定概率或信念应该如何随着相关新信息的到来而改变。前面的凯恩斯引言捕捉了那种精神。它依赖于条件和总概率以及链式法则；有关介绍和更多信息，请参见Bishop（2006）和Gelman等人（2013）。
- en: 'The probabilistic belief concerns a single parameter or a vector of parameters
    ![](img/Image66193.png) (also: hypotheses). Each parameter can be discrete or
    continuous. ![](img/B15439_10_003.png) could be a one-dimensional statistic like
    the (discrete) mode of a categorical variable or a (continuous) mean, or a higher
    dimensional set of values like a covariance matrix or the weights of a deep neural
    network.'
  id: totrans-25
  prefs: []
  type: TYPE_NORMAL
  zh: 概率信念涉及单个参数或参数向量![](img/Image66193.png)（也称为假设）。每个参数可以是离散的或连续的。![](img/B15439_10_003.png)可以是一维统计量，例如（离散的）分类变量的众数或（连续的）均值，或者是更高维的值集，例如协方差矩阵或深度神经网络的权重。
- en: A key difference to frequentist statistics is that Bayesian assumptions are
    expressed as probability distributions rather than parameter values. Consequently,
    while frequentist inference focuses on point estimates, Bayesian inference yields
    probability distributions.
  id: totrans-26
  prefs: []
  type: TYPE_NORMAL
  zh: 与频率统计学的关键区别在于，贝叶斯假设是以概率分布而不是参数值表示的。因此，频率派推断侧重于点估计，而贝叶斯推断产生概率分布。
- en: 'Bayes'' theorem updates the beliefs about the parameters of interest by computing
    the **posterior probability distribution** from the following inputs, as shown
    in *Figure 10.1*:'
  id: totrans-27
  prefs: []
  type: TYPE_NORMAL
  zh: 贝叶斯定理通过计算从以下输入计算**后验概率分布**来更新对感兴趣参数的信念，如图10.1所示：
- en: The **prior** distribution indicates how likely we consider each possible hypothesis.
  id: totrans-28
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 先验分布表示我们考虑每个可能假设的可能性有多大。
- en: The **likelihood function** outputs the probability of observing a dataset when
    given certain values for the parameters ![](img/B15439_10_003.png), that is, for
    a specific hypothesis.
  id: totrans-29
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**似然函数**输出在给定参数 ![](img/B15439_10_003.png) 值时观察到数据集的概率，即针对特定假设。'
- en: The **evidence** measures how likely the observed data is, given all possible
    hypotheses. Hence, it is the same for all parameter values and serves to normalize
    the numerator.
  id: totrans-30
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**证据**衡量了给定所有可能假设的观察数据的可能性。因此，对于所有参数值，它是相同的，并用于规范化分子。'
- en: '![](img/B15439_10_01.png)'
  id: totrans-31
  prefs: []
  type: TYPE_IMG
  zh: '![](img/B15439_10_01.png)'
- en: 'Figure 10.1: How evidence updates the prior to the posterior probability distribution'
  id: totrans-32
  prefs: []
  type: TYPE_NORMAL
  zh: 图 10.1：证据如何更新先验到后验概率分布
- en: The posterior is the product of prior and likelihood, divided by the evidence.
    Thus, it reflects the probability distribution of the hypothesis, updated by taking
    into account both prior assumptions and the data. Viewed differently, the posterior
    probability results from applying the chain rule, which, in turn, factorizes the
    joint distribution of data and parameters.
  id: totrans-33
  prefs: []
  type: TYPE_NORMAL
  zh: 后验是先验和似然的乘积，除以证据。因此，它反映了假设的概率分布，通过考虑先前假设和数据更新。从不同角度看，后验概率来自应用链式规则，这反过来将数据和参数的联合分布分解为因子。
- en: With higher-dimensional, continuous variables, the formulation becomes more
    complex and involves (multiple) integrals. Also, an alternative formulation uses
    odds to express the posterior odds as the product of the prior odds, times the
    likelihood ratio (see Gelman et al. 2013).
  id: totrans-34
  prefs: []
  type: TYPE_NORMAL
  zh: 对于更高维度、连续变量，该公式变得更加复杂，涉及（多个）积分。此外，另一种表述使用赔率将后验赔率表达为先验赔率乘以似然比（参见Gelman等人2013年）。
- en: Exact inference – maximum a posteriori estimation
  id: totrans-35
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 精确推断 - 最大后验估计
- en: Practical applications of Bayes' rule to exactly compute posterior probabilities
    are quite limited. This is because the computation of the evidence term in the
    denominator is quite challenging. The evidence reflects the probability of the
    observed data over all possible parameter values. It is also called the *marginal
    likelihood* because it requires "marginalizing out" the parameters' distribution
    by adding or integrating over their distribution. This is generally only possible
    in simple cases with a small number of discrete parameters that assume very few
    values.
  id: totrans-36
  prefs: []
  type: TYPE_NORMAL
  zh: 将贝叶斯定理应用于精确计算后验概率的实际应用非常有限。这是因为计算分母中的证据项相当具有挑战性。证据反映了观察数据在所有可能参数值上的概率。它也被称为*边际似然*，因为它需要通过添加或对其分布进行积分来“边缘化”参数的分布。这通常仅在具有少量假设值的少量离散参数的简单情况下才可能。
- en: '**Maximum a posteriori probability** (**MAP**) estimation leverages the fact
    that the evidence is a constant factor that scales the posterior to meet the requirements
    for a probability distribution. Since the evidence does not depend on ![](img/B15439_10_006.png),
    the posterior distribution is proportional to the product of the likelihood and
    the prior. Hence, MAP estimation chooses the value of ![](img/B15439_10_006.png)
    that maximizes the posterior given the observed data and the prior belief, that
    is, the mode of the posterior.'
  id: totrans-37
  prefs: []
  type: TYPE_NORMAL
  zh: 最大后验概率（**MAP**）估计利用了证据是一个将后验缩放到满足概率分布要求的常数因子的事实。由于证据不依赖于 ![](img/B15439_10_006.png)，后验分布与似然和先验的乘积成正比。因此，MAP估计选择使后验最大化的值，给定观察到的数据和先验信念，即后验的模式。
- en: The MAP approach contrasts with the **Maximum Likelihood Estimation** (**MLE**)
    of parameters that define a **probability distribution**. MLE picks the parameter
    value ![](img/B15439_10_006.png) that maximizes the likelihood function for the
    observed training data.
  id: totrans-38
  prefs: []
  type: TYPE_NORMAL
  zh: MAP方法与定义概率分布的参数的最大似然估计（**MLE**）相对比。MLE选择最大化观察训练数据的似然函数的参数值！[](img/B15439_10_006.png)。
- en: 'A look at the definitions highlights that **MAP differs from MLE by including
    the prior distribution**. In other words, unless the prior is a constant, the
    MAP estimate will differ from its MLE counterpart:'
  id: totrans-39
  prefs: []
  type: TYPE_NORMAL
  zh: 通过定义可以看出，**MAP与MLE的不同之处在于包括先验分布**。换句话说，除非先验是一个常数，否则MAP估计将与其MLE对应物不同：
- en: '![](img/B15439_10_007.png)'
  id: totrans-40
  prefs: []
  type: TYPE_IMG
  zh: '![](img/B15439_10_007.png)'
- en: The MLE solution tends to reflect the frequentist notion that probability estimates
    should reflect observed ratios. On the other hand, the impact of the prior on
    the MAP estimate often corresponds to adding data that reflects the prior assumptions
    to the MLE. For example, a strong prior that a coin is biased can be incorporated
    in the MLE context by adding skewed trial data.
  id: totrans-41
  prefs: []
  type: TYPE_NORMAL
  zh: MLE解决方案往往反映了频率学观念，即概率估计应反映观察到的比率。另一方面，先验对MAP估计的影响通常对应于将反映先验假设的数据添加到MLE中。例如，一个关于硬币偏向的强先验可以通过添加倾斜的试验数据来纳入MLE环境中。
- en: Prior distributions are a critical ingredient to Bayesian models. We will now
    introduce some convenient choices that facilitate analytical inference.
  id: totrans-42
  prefs: []
  type: TYPE_NORMAL
  zh: 先验分布是贝叶斯模型的关键组成部分。我们现在将介绍一些便利的选择，以促进分析推断。
- en: How to select priors
  id: totrans-43
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 如何选择先验
- en: The prior should reflect knowledge about the distribution of the parameters
    because it influences the MAP estimate. If a prior is not known with certainty,
    we need to make a choice, often from several reasonable options. In general, it
    is good practice to justify the prior and check for robustness by testing whether
    alternatives lead to the same conclusion.
  id: totrans-44
  prefs: []
  type: TYPE_NORMAL
  zh: 先验应该反映对参数分布的了解，因为它影响着MAP估计。如果先验不确定，我们需要做出选择，通常从几个合理的选项中选择。一般来说，证明先验并通过测试替代是否导致相同结论是一种良好的做法。
- en: 'There are several types of priors:'
  id: totrans-45
  prefs: []
  type: TYPE_NORMAL
  zh: 有几种类型的先验：
- en: '**Objective** priors maximize the impact of the data on the posterior. If the
    parameter distribution is unknown, we can select an uninformative prior like a
    uniform distribution, also called a *flat prior*, over a relevant range of parameter
    values.'
  id: totrans-46
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**客观**先验将最大化数据对后验的影响。如果参数分布未知，我们可以选择一个无信息的先验，如参数值的相关范围上的均匀分布，也称为*平坦先验*。'
- en: In contrast, **subjective** priors aim to incorporate information external to
    the model into the estimate. In the Black-Litterman context, the investor's belief
    about an asset's future return would be an example of a subjective prior.
  id: totrans-47
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 相比之下，**主观**先验旨在将模型外的信息纳入估计中。在Black-Litterman环境中，投资者对资产未来收益的信念将是主观先验的一个例子。
- en: An **empirical** prior combines Bayesian and frequentist methods and uses historical
    data to eliminate subjectivity, for example, by estimating various moments to
    fit a standard distribution. Using some historical average of daily returns rather
    than a belief about future returns would be an example of a simple empirical prior.
  id: totrans-48
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 一个**经验**先验结合了贝叶斯和频率主义方法，并利用历史数据消除了主观性，例如，通过估计各种时刻来拟合标准分布。使用一些历史上的日收益率平均值而不是对未来收益的信念，就是一个简单经验先验的例子。
- en: In the context of an ML model, the prior can be viewed as a regularizer because
    it limits the values that the posterior can assume. Parameters that have zero
    prior probability, for instance, are not part of the posterior distribution. Generally,
    more good data allows for stronger conclusions and reduces the influence of the
    prior.
  id: totrans-49
  prefs: []
  type: TYPE_NORMAL
  zh: 在ML模型的上下文中，先验可以被视为正则化器，因为它限制了后验可以假设的值。例如，具有零先验概率的参数不是后验分布的一部分。通常，更多的好数据允许得出更强的结论，并减少先验的影响。
- en: How to keep inference simple – conjugate priors
  id: totrans-50
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 如何保持推断简单 - 共轭先验
- en: A prior distribution is conjugate with respect to the likelihood when the resulting
    posterior is of the same class or family of distributions as the prior, except
    for different parameters. For example, when both the prior and the likelihood
    are normally distributed, then the posterior is also normally distributed.
  id: totrans-51
  prefs: []
  type: TYPE_NORMAL
  zh: 当得到的后验与先验相同类或家族的分布相同时，先验分布与似然函数共轭。例如，当先验和似然都是正态分布时，后验也是正态分布的。
- en: The conjugacy of prior and likelihood implies a **closed-form solution for the
    posterior** that facilitates the update process and avoids the need to use numerical
    methods to approximate the posterior. Moreover, the resulting posterior can be
    used as the prior for the next update step.
  id: totrans-52
  prefs: []
  type: TYPE_NORMAL
  zh: 先验和似然的共轭意味着**后验的封闭形式解**，有利于更新过程，并避免使用数值方法来近似后验。此外，得到的后验可以用作下一次更新步骤的先验。
- en: Let's illustrate this process using a binary classification example for stock
    price movements.
  id: totrans-53
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们用股票价格变动的二元分类例子来说明这个过程。
- en: Dynamic probability estimates of asset price moves
  id: totrans-54
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 资产价格变动的动态概率估计
- en: When the data consists of binary Bernoulli random variables with a certain success
    probability for a positive outcome, the number of successes in repeated trials
    follows a binomial distribution. The conjugate prior is the beta distribution
    with support over the interval [0, 1] and two shape parameters to model arbitrary
    prior distributions over the success probability. Hence, the posterior distribution
    is also a beta distribution that we can derive by directly updating the parameters.
  id: totrans-55
  prefs: []
  type: TYPE_NORMAL
  zh: 当数据由具有某一成功概率的二元伯努利随机变量组成时，重复试验中的成功次数遵循二项分布。共轭先验是支持区间[0,1]上的贝塔分布，并具有两个形状参数，以对成功概率上的任意先验分布进行建模。因此，后验分布也是一个贝塔分布，我们可以通过直接更新参数来得到。
- en: We will collect samples of different sizes of **binarized daily S&P 500 returns**,
    where the positive outcome is a price increase. Starting from an uninformative
    prior that allocates equal probability to each possible success probability in
    the interval [0, 1], we compute the posterior for different evidence samples.
  id: totrans-56
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将收集不同大小的**二值化的每日标普500指数收益率**样本，其中正面结果是价格上涨。从一个不具信息的先验开始，在区间[0,1]中为每个可能的成功概率分配相等的概率，我们计算不同证据样本的后验概率。
- en: 'The following code sample shows that the update consists of simply adding the
    observed numbers of success and failure to the parameters of the prior distribution
    to obtain the posterior:'
  id: totrans-57
  prefs: []
  type: TYPE_NORMAL
  zh: 下面的代码示例显示，更新仅涉及将观察到的成功和失败的数量添加到先验分布的参数中以获得后验：
- en: '[PRE0]'
  id: totrans-58
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: The resulting posterior distributions have been plotted in the following image.
    They illustrate the evolution from a uniform prior that views all success probabilities
    as equally likely to an increasingly peaked distribution.
  id: totrans-59
  prefs: []
  type: TYPE_NORMAL
  zh: 结果后验分布已绘制在下图中。它们说明了从将所有成功概率视为等可能的均匀先验到越来越尖峰分布的演变。
- en: 'After 500 samples, the probability is concentrated near the actual probability
    of a positive move at 54.7 percent from 2010 to 2017\. It also shows the small
    differences between MLE and MAP estimates, where the latter tends to be pulled
    slightly toward the expected value of the uniform prior:'
  id: totrans-60
  prefs: []
  type: TYPE_NORMAL
  zh: 经过500个样本后，从2010年到2017年，正向移动的概率集中在实际概率的54.7％附近。它还显示了MLE和MAP估计之间的小差异，后者倾向于被稍微拉向均匀先验的期望值：
- en: '![](img/B15439_10_02.png)'
  id: totrans-61
  prefs: []
  type: TYPE_IMG
  zh: '![](img/B15439_10_02.png)'
- en: 'Figure 10.2: Posterior distributions of the probability that the S&P 500 goes
    up the next day after up to 500 updates'
  id: totrans-62
  prefs: []
  type: TYPE_NORMAL
  zh: 图10.2：经过最多500次更新后的标普500指数第二天上涨概率的后验分布
- en: 'In practice, the use of conjugate priors is limited to low-dimensional cases.
    In addition, the simplified MAP approach avoids computing the evidence term but
    has a key shortcoming, even when it is available: it does not return a distribution
    so that we can derive a measure of uncertainty or use it as a prior. Hence, we
    need to resort to an approximate rather than exact inference using numerical methods
    and stochastic simulations, which we will introduce next.'
  id: totrans-63
  prefs: []
  type: TYPE_NORMAL
  zh: 在实践中，使用共轭先验的情况受到低维情况的限制。此外，简化的MAP方法避免了计算证据项，但有一个关键缺点，即使在可用时也是如此：它不返回分布，因此我们无法得出不确定性的度量或将其用作先验。因此，我们需要使用数值方法和随机模拟进行近似推断，而不是精确推断，接下来我们将介绍。
- en: Deterministic and stochastic approximate inference
  id: totrans-64
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 确定性和随机近似推断
- en: 'For most models of practical relevance, it will not be possible to derive the
    exact posterior distribution analytically and compute expected values for the
    latent parameters. The model may have too many parameters, or the posterior distribution
    may be too complex for an analytical solution:'
  id: totrans-65
  prefs: []
  type: TYPE_NORMAL
  zh: 对于大多数具有实际相关性的模型，将无法解析地推导出精确的后验分布并计算潜在参数的期望值。模型可能具有太多参数，或者后验分布可能对于解析解而言过于复杂：
- en: For **continuous variables**, the integrals may not have closed-form solutions,
    while the dimensionality of the space and the complexity of the integrand may
    prohibit numerical integration.
  id: totrans-66
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 对于**连续变量**，积分可能没有封闭形式的解，而空间的维数和被积函数的复杂性可能会阻止数值积分。
- en: For **discrete variables**, the marginalizations involve summing over all possible
    configurations of the hidden variables, and though this is always possible in
    principle, we often find in practice that there may be exponentially many hidden
    states that render this calculation prohibitively expensive.
  id: totrans-67
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 对于**离散变量**，边缘化涉及对所有可能的隐藏变量配置求和，尽管这在原则上总是可能的，但实践中我们经常发现可能存在指数多个隐藏状态，使得这种计算代价过高。
- en: 'Although for some applications the posterior distribution over unobserved parameters
    will be of interest, most often, it is primarily required to evaluate expectations,
    for example, to make predictions. In such situations, we can rely on approximate
    inference, which includes stochastic and deterministic approaches:'
  id: totrans-68
  prefs: []
  type: TYPE_NORMAL
  zh: 尽管对于一些应用来说，未观察参数的后验分布可能很重要，但通常主要是需要评估期望，例如进行预测。在这种情况下，我们可以依赖于近似推断，其中包括随机和确定性方法：
- en: '**Stochastic** techniques based on **Markov chain Monte Carlo** (**MCMC**)
    sampling have popularized the use of Bayesian methods across many domains. They
    generally have the property to converge to the exact result. In practice, sampling
    methods can be computationally demanding and are often limited to small-scale
    problems.'
  id: totrans-69
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 基于**马尔可夫链蒙特卡罗**(**MCMC**)抽样的**随机**技术已经在许多领域推广了贝叶斯方法的使用。它们通常具有收敛到精确结果的属性。在实践中，抽样方法可能计算成本高，通常仅限于小规模问题。
- en: '**Deterministic** methods called **variational inference** or **variational
    Bayes** are based on analytical approximations to the posterior distribution and
    can scale well to large applications. They make simplifying assumptions, for example,
    that the posterior factorizes in a particular way or it has a specific parametric
    form, such as a Gaussian. Hence, they do not generate exact results and can be
    used as complements to sampling methods.'
  id: totrans-70
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 称为**变分推断**或**变分贝叶斯**的**确定性**方法基于对后验分布的解析近似，并且可以很好地扩展到大型应用程序。它们进行简化假设，例如，后验分解为特定方式或具有特定参数形式，例如高斯分布。因此，它们不生成精确结果，并且可以用作抽样方法的补充。
- en: We will outline both approaches in the following two sections.
  id: totrans-71
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将在接下来的两个部分概述这两种方法。
- en: Markov chain MonteCarlo sampling
  id: totrans-72
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 马尔可夫链蒙特卡罗抽样
- en: Sampling is about drawing samples *X*=(*x*[1], …, *x*[n]) from a given distribution
    *p*(*x*). Assuming the samples are independent, the law of large numbers ensures
    that for a growing number of samples, the fraction of a given instance *x*[i]
    in the sample (for the discrete case) corresponds to its probability *p*(*x*=*x*[i]).
    In the continuous case, the analogous reasoning applies to a given region of the
    sample space. Hence, averages over samples can be used as unbiased estimators
    of the expected values of parameters of the distribution.
  id: totrans-73
  prefs: []
  type: TYPE_NORMAL
  zh: 抽样是指从给定分布*p*(*x*)中绘制样本*X*=(*x*[1], …, *x*[n])。假设样本是独立的，大数定律确保对于增加的样本数量，样本中给定实例*x*[i]的比例（对于离散情况）对应于其概率*p*(*x*=*x*[i])。在连续情况下，类似的推理适用于样本空间的给定区域。因此，对样本的平均值可以用作分布参数的期望值的无偏估计量。
- en: A practical challenge consists of ensuring independent sampling because the
    distribution is unknown. Dependent samples may still be unbiased, but tend to
    increase the variance of the estimate, so that more samples will be needed for
    an equally precise estimate as for independent samples.
  id: totrans-74
  prefs: []
  type: TYPE_NORMAL
  zh: 实际挑战之一是确保独立抽样，因为分布是未知的。依赖样本可能仍然是无偏的，但往往会增加估计的方差，因此需要更多的样本来获得与独立样本相同的精确估计。
- en: Sampling from a multivariate distribution is computationally demanding as the
    number of states increases exponentially with the number of dimensions. Numerous
    algorithms facilitate the process; we will introduce a few popular variations
    of MCMC-based methods here.
  id: totrans-75
  prefs: []
  type: TYPE_NORMAL
  zh: 从多元分布中抽样在状态数量随维度数呈指数增长时计算成本很高。许多算法简化了这个过程；我们将在这里介绍几种基于MCMC的流行变体。
- en: A **Markov chain** is a dynamic stochastic model that describes a random walk
    over a set of states connected by transition probabilities. The Markov property
    stipulates that the process has no memory and that the next step only depends
    on the current state. In other words, this depends on whether the present, past,
    and future are independent, that is, information about past states does not help
    to predict the future beyond what we know from the present.
  id: totrans-76
  prefs: []
  type: TYPE_NORMAL
  zh: '**马尔可夫链**是描述一组由转移概率连接的状态上的随机游走的动态随机模型。马尔可夫属性规定了过程没有记忆，并且下一步仅取决于当前状态。换句话说，这取决于当前、过去和未来是否独立，也就是说，过去状态的信息不会帮助我们预测未来超出我们从现在所知道的内容。'
- en: '**Monte Carlo methods** rely on repeated random sampling to approximate results
    that may be deterministic but that do not permit an exact analytic solution. It
    was developed during the Manhattan Project to estimate energy at the atomic level
    and received its enduring code name to ensure secrecy.'
  id: totrans-77
  prefs: []
  type: TYPE_NORMAL
  zh: '**蒙特卡罗方法**依赖于重复随机抽样来近似可能是确定性的但不允许精确解析解的结果。它在曼哈顿计划期间开发，用于估算原子级别的能量，并获得了其持久的代码名称以确保保密性。'
- en: 'Many algorithms apply the Monte Carlo method to a Markov chain and generally
    proceed as follows:'
  id: totrans-78
  prefs: []
  type: TYPE_NORMAL
  zh: 许多算法将蒙特卡罗方法应用于马尔可夫链，并通常按以下方式进行：
- en: Start at the current position
  id: totrans-79
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 从当前位置开始。
- en: Draw a new position from a proposal distribution
  id: totrans-80
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 从提议分布中绘制一个新位置。
- en: Evaluate the probability of the new position in light of data and prior distributions
  id: totrans-81
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 根据数据和先验分布评估新位置的概率。
- en: If sufficiently likely, move to the new position
  id: totrans-82
  prefs:
  - PREF_IND
  - PREF_OL
  type: TYPE_NORMAL
  zh: 如果足够可能，移动到新位置。
- en: Otherwise, remain at the current position
  id: totrans-83
  prefs:
  - PREF_IND
  - PREF_OL
  type: TYPE_NORMAL
  zh: 否则，保持在当前位置。
- en: Repeat from *step 1*
  id: totrans-84
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 从*步骤1*重复。
- en: After a given number of iterations, return all accepted positions
  id: totrans-85
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 经过一定数量的迭代后，返回所有被接受的位置。
- en: MCMC methods aim to identify and explore interesting regions of the posterior
    that concentrate significant probability density. The memoryless process is said
    to converge when it consistently moves through nearby high-probability states
    of the posterior where the acceptance rate increases. A key challenge is to balance
    the need for random exploration of the sample space with the risk of reducing
    the acceptance rate.
  id: totrans-86
  prefs: []
  type: TYPE_NORMAL
  zh: MCMC方法旨在识别和探索后验中集中显著概率密度的有趣区域。当它连续地移动到后验的附近高概率状态时，被称为无记忆过程的过程收敛。一个关键挑战是平衡对样本空间随机探索的需求与降低接受率的风险。
- en: The initial steps of the process are likely more reflective of the starting
    position than the posterior, and are typically discarded as *burn-in* **samples**.
    A key MCMC property is that the process should "forget" about its initial position
    after a certain (but unknown) number of iterations.
  id: totrans-87
  prefs: []
  type: TYPE_NORMAL
  zh: 过程的初始步骤可能更多地反映了起始位置而不是后验，并且通常被丢弃作为*burn-in* **样本**。 MCMC的一个关键属性是在一定（但未知）数量的迭代之后，该过程应“忘记”其初始位置。
- en: The remaining samples are called the **trace** of the process. Assuming convergence,
    the relative frequency of samples approximates the posterior and can be used to
    compute expected values based on the law of large numbers.
  id: totrans-88
  prefs: []
  type: TYPE_NORMAL
  zh: 剩下的样本被称为该过程的**迹**。假设收敛，则样本的相对频率近似后验，并且可以根据大数定律计算期望值。
- en: As already indicated, the precision of the estimate depends on the serial correlation
    of the samples collected by the random walk, each of which, by design, depends
    only on the previous state. Higher correlation limits the effective exploration
    of the posterior and needs to be subjected to diagnostic tests.
  id: totrans-89
  prefs: []
  type: TYPE_NORMAL
  zh: 如前所述，估计的精度取决于由随机游走收集的样本的串行相关性，其中每个样本设计上仅依赖于前一个状态。更高的相关性限制了对后验的有效探索，并且需要进行诊断测试。
- en: General techniques to design such a Markov chain include Gibbs sampling, the
    Metropolis-Hastings algorithm, and more recent Hamiltonian MCMC methods, which
    tend to perform better.
  id: totrans-90
  prefs: []
  type: TYPE_NORMAL
  zh: 设计这样一个马尔可夫链的一般技术包括Gibbs抽样、Metropolis-Hastings算法和更近期的哈密顿MCMC方法，后者通常表现更好。
- en: Gibbs sampling
  id: totrans-91
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: Gibbs抽样
- en: Gibbs sampling simplifies multivariate sampling to a sequence of one-dimensional
    draws. From some starting point, it iteratively holds *n*-1 variables constant
    while sampling the *n*^(th) variable. It incorporates this sample and repeats
    it.
  id: totrans-92
  prefs: []
  type: TYPE_NORMAL
  zh: Gibbs抽样将多变量抽样简化为一系列一维绘制。从某个起始点开始，它在抽样第*n*个变量时迭代地保持*n*-1个变量不变。它包含了这个样本并重复它。
- en: The algorithm is very simple and easy to implement but produces highly correlated
    samples that slow down convergence. The sequential nature also prevents parallelization.
    See Casella and George (1992) for a detailed description and explanation.
  id: totrans-93
  prefs: []
  type: TYPE_NORMAL
  zh: 该算法非常简单易实现，但产生高度相关的样本，减慢了收敛速度。顺序性质也阻止了并行化。详见 Casella 和 George (1992) 中对其的详细描述和解释。
- en: Metropolis-Hastings sampling
  id: totrans-94
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: Metropolis-Hastings 取样
- en: The Metropolis-Hastings algorithm randomly proposes new locations based on its
    current state. It does so to effectively explore the sample space and reduce the
    correlation of samples relative to Gibbs sampling. To ensure that it samples from
    the posterior, it evaluates the proposal using the product of prior and likelihood,
    which is proportional to the posterior. It accepts with a probability that depends
    on the result relative to the corresponding value for the current sample.
  id: totrans-95
  prefs: []
  type: TYPE_NORMAL
  zh: Metropolis-Hastings 算法根据当前状态随机提出新的位置。它这样做是为了有效地探索样本空间并减少相对于 Gibbs 采样的样本相关性。为了确保它从后验中取样，它使用先验和似然的乘积来评估提议，这与后验成比例。它接受的概率取决于结果相对于当前样本的相应值。
- en: A key benefit of the proposal evaluation method is that it works with a proportional
    rather than an exact evaluation of the posterior. However, it can take a long
    time to converge. This is because the random movements that are not related to
    the posterior can reduce the acceptance rate so that a large number of steps produces
    only a small number of (potentially correlated) samples. The acceptance rate can
    be tuned by reducing the variance of the proposal distribution, but the resulting
    smaller steps imply less exploration. See Chib and Greenberg (1995) for a detailed,
    introductory exposition of the algorithm.
  id: totrans-96
  prefs: []
  type: TYPE_NORMAL
  zh: 提议评估方法的一个关键优点是，它使用与后验的精确评估不同的比例评估。但是，它可能需要很长时间才能收敛。这是因为与后验无关的随机移动可能会降低接受率，从而使大量步骤只产生少量（可能相关的）样本。接受率可以通过减小提议分布的方差来调节，但由此产生的较小步骤意味着较少的探索。详见
    Chib 和 Greenberg (1995) 中对该算法的详细介绍。
- en: Hamiltonian Monte Carlo – going NUTS
  id: totrans-97
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 汉密尔顿蒙特卡洛 – 进入 NUTS
- en: '**Hamiltonian Monte Carlo** (**HMC**) is a hybrid method that leverages the
    first-order derivative information of the gradient of the likelihood. With this,
    it proposes new states for exploration and overcomes some of the MCMC challenges.
    In addition, it incorporates momentum to efficiently "jump around" the posterior.
    As a result, it converges faster to a high-dimensional target distribution than
    simpler random walk Metropolis or Gibbs sampling. See Betancourt (2018) for a
    comprehensive conceptual introduction.'
  id: totrans-98
  prefs: []
  type: TYPE_NORMAL
  zh: '**汉密尔顿蒙特卡洛** (**HMC**) 是一种混合方法，利用了似然梯度的一阶导数信息。借助此信息，它提出了新的状态以进行探索，并克服了一些 MCMC
    的挑战。此外，它结合了动量以有效地在后验中“跳跃”。因此，它比简单的随机行走 Metropolis 或 Gibbs 采样更快地收敛到高维目标分布。详见 Betancourt
    (2018) 中全面的概念介绍。'
- en: The **No U-Turn Sampler** (**NUTS**, Hoffman and Gelman 2011) is a self-tuning
    HMC extension that adaptively regulates the size and number of moves around the
    posterior before selecting a proposal. It works well on high-dimensional and complex
    posterior distributions, and allows many complex models to be fit without specialized
    knowledge about the fitting algorithm itself. As we will see in the next section,
    it is the default sampler in **PyMC3**.
  id: totrans-99
  prefs: []
  type: TYPE_NORMAL
  zh: '**无 U-Turn 采样器** (**NUTS**, Hoffman 和 Gelman 2011) 是一种自调整的 HMC 扩展，它在选择提议之前自适应地调节后验周围的移动的大小和数量。它在高维和复杂的后验分布上表现良好，并允许拟合许多复杂模型而无需关于拟合算法本身的专业知识。正如我们将在下一节中看到的，它是
    **PyMC3** 中的默认采样器。'
- en: Variational inference and automatic differentiation
  id: totrans-100
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 变分推断和自动微分
- en: '**Variational inference** (**VI**) is an ML method that approximates probability
    densities through optimization. In the Bayesian context, it approximates the posterior
    distribution, as follows:'
  id: totrans-101
  prefs: []
  type: TYPE_NORMAL
  zh: '**变分推断** (**VI**) 是一种通过优化来近似概率密度的机器学习方法。在贝叶斯背景下，它近似后验分布，如下所示：'
- en: Select a parametrized family of probability distributions
  id: totrans-102
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 选择一个参数化的概率分布族
- en: Find the member of this family closest to the target, as measured by Kullback-Leibler
    divergence
  id: totrans-103
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 找到该族中距离目标最近的成员，其度量为 Kullback-Leibler 散度
- en: Compared to MCMC, variational Bayes tends to converge faster and scales better
    to large data. While MCMC approximates the posterior with samples from the chain
    that will eventually converge arbitrarily close to the target, variational algorithms
    approximate the posterior with the result of the optimization that is not guaranteed
    to coincide with the target.
  id: totrans-104
  prefs: []
  type: TYPE_NORMAL
  zh: 与 MCMC 相比，变分贝叶斯倾向于更快地收敛并且对大数据具有更好的可扩展性。虽然 MCMC 通过来自链条的样本逼近后验概率，这些样本最终将收敛到目标任意接近的地方，但变分算法通过优化的结果来逼近后验概率，不能保证与目标重合。
- en: Variational inference is better suited for large datasets, for example, hundreds
    of millions of text documents, so we can quickly explore many models. In contrast,
    MCMC will deliver more accurate results on smaller datasets or when time and computational
    resources pose fewer constraints. For example, MCMC would be a good choice if
    you had spent 20 years collecting a small but expensive dataset, are confident
    that your model is appropriate, and you require precise inferences. See Salimans,
    Kingma, and Welling (2015) for a more detailed comparison.
  id: totrans-105
  prefs: []
  type: TYPE_NORMAL
  zh: 变分推断更适用于大型数据集，例如，数亿个文本文档，因此我们可以快速探索许多模型。相反，当时间和计算资源的约束较少时，MCMC 将在较小的数据集上提供更精确的结果。例如，如果您花了
    20 年时间收集了一个小但昂贵的数据集，并且确信您的模型是适当的，并且您需要精确的推断，则 MCMC 将是一个不错的选择。有关更详细的比较，请参见 Salimans、Kingma
    和 Welling（2015）。
- en: The downside of variational inference is the need for model-specific derivations
    and the implementation of a tailored optimization routine, which slows down widespread
    adoption.
  id: totrans-106
  prefs: []
  type: TYPE_NORMAL
  zh: 变分推断的缺点是需要模型特定的导出和定制优化例程的实现，这减慢了广泛采用的速度。
- en: The recent **Automatic Differentiation Variational Inference** (**ADVI**) algorithm
    automates this process so that the user only specifies the model, expressed as
    a program, and ADVI automatically generates a corresponding variational algorithm
    (see the references on GitHub for implementation details).
  id: totrans-107
  prefs: []
  type: TYPE_NORMAL
  zh: 最近的**自动微分变分推断**（**ADVI**）算法自动化了这个过程，使得用户只需指定模型，表达为一个程序，ADVI会自动生成相应的变分算法（详见 GitHub
    上的参考资料以了解实现细节）。
- en: We will see that **PyMC3 supports various variational inference techniques**,
    including ADVI.
  id: totrans-108
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将看到 **PyMC3 支持各种变分推断技术**，包括 ADVI。
- en: Probabilistic programming with PyMC3
  id: totrans-109
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 使用 PyMC3 的概率编程
- en: Probabilistic programming provides a language to describe and fit probability
    distributions so that we can design, encode, and automatically estimate and evaluate
    complex models. It aims to abstract away some of the computational and analytical
    complexity to allow us to focus on the conceptually more straightforward and intuitive
    aspects of Bayesian reasoning and inference.
  id: totrans-110
  prefs: []
  type: TYPE_NORMAL
  zh: 概率编程提供了一种描述和拟合概率分布的语言，以便我们可以设计、编码并自动估计和评估复杂的模型。它旨在抽象出一些计算和分析复杂性，以便我们可以专注于贝叶斯推理和推断的概念上更直观、更简单的方面。
- en: The field has become quite dynamic since new languages emerged after Uber open
    sourced Pyro (based on PyTorch). Google, more recently, added a probability module
    to TensorFlow.
  id: totrans-111
  prefs: []
  type: TYPE_NORMAL
  zh: 自 Uber 开源了 Pyro（基于 PyTorch）后，该领域变得非常动态。最近，Google 为 TensorFlow 添加了一个概率模块
- en: As a result, the practical relevance and use of Bayesian methods in ML will
    likely increase to generate insights into uncertainty and, in particular, for
    use cases that require transparent rather than black-box models.
  id: totrans-112
  prefs: []
  type: TYPE_NORMAL
  zh: 因此，贝叶斯方法在机器学习中的实际相关性和使用可能会增加，以生成对不确定性有洞察力的见解，特别是对于需要透明而不是黑匣子模型的用例。
- en: In this section, we will introduce the popular **PyMC3** library, which implements
    advanced MCMC sampling and variational inference for ML models using Python. Together
    with **Stan** (named after Stanislaw Ulam, who invented the Monte Carlo method,
    and developed by Andrew Gelman at Columbia University since 2012), PyMC3 is the
    most popular probabilistic programming language.
  id: totrans-113
  prefs: []
  type: TYPE_NORMAL
  zh: 在本节中，我们将介绍流行的**PyMC3**库，该库使用 Python 为 ML 模型实现了高级 MCMC 抽样和变分推断。与 **Stan**（以蒙特卡罗方法发明者
    Stanislaw Ulam 命名，由哥伦比亚大学的 Andrew Gelman 自 2012 年以来开发）一起，PyMC3 是最受欢迎的概率编程语言。
- en: Bayesian machine learning with Theano
  id: totrans-114
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 使用 Theano 的贝叶斯机器学习
- en: PyMC3 was released in January 2017 to add Hamiltonian MC methods to the Metropolis-Hastings
    sampler used in PyMC2 (released 2012). PyMC3 uses Theano as its computational
    backend for dynamic C compilation and automatic differentiation. Theano is a matrix-focused
    and GPU-enabled optimization library developed at Yoshua Bengio's **Montreal Institute
    for Learning Algorithms** (**MILA**), which inspired TensorFlow. MILA recently
    ceased to further develop Theano due to the success of newer deep learning libraries
    (see *Chapter 16*, *Word Embeddings for Earnings Calls and SEC Filings*, for details).
  id: totrans-115
  prefs: []
  type: TYPE_NORMAL
  zh: PyMC3于2017年1月发布，以将Hamiltonian MC方法添加到PyMC2（2012年发布）中使用的Metropolis-Hastings采样器中。PyMC3使用Theano作为其计算后端，用于动态C编译和自动微分。Theano是由Yoshua
    Bengio的**蒙特利尔学习算法研究所**（**MILA**）开发的一个以矩阵为重点且支持GPU的优化库，这启发了TensorFlow。由于更新的深度学习库的成功，MILA最近停止进一步开发Theano（详见*第16章*，*收益电话和SEC文件的单词嵌入*）。
- en: PyMC4, released in alpha in December 2019, uses TensorFlow instead of Theano
    and aims to limit the impact on the API (see the link to the repository on GitHub).
  id: totrans-116
  prefs: []
  type: TYPE_NORMAL
  zh: PyMC4于2019年12月发布alpha版，使用TensorFlow代替Theano，并旨在限制对API的影响（请参阅GitHub上的存储库链接）。
- en: The PyMC3 workflow – predicting a recession
  id: totrans-117
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: PyMC3工作流程 - 预测衰退
- en: 'PyMC3 aims for intuitive and readable, yet powerful, syntax that reflects how
    statisticians describe models. The modeling process generally follows these three
    steps:'
  id: totrans-118
  prefs: []
  type: TYPE_NORMAL
  zh: PyMC3旨在实现直观、易读且功能强大的语法，反映了统计学家描述模型的方式。建模过程通常遵循以下三个步骤：
- en: 'Encode a probability model by defining:'
  id: totrans-119
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 通过定义编码概率模型：
- en: The prior distributions that quantify knowledge and uncertainty about latent
    variables
  id: totrans-120
  prefs:
  - PREF_IND
  - PREF_OL
  type: TYPE_NORMAL
  zh: 量化潜变量的知识和不确定性的先验分布
- en: The likelihood function that conditions the parameters on observed data
  id: totrans-121
  prefs:
  - PREF_IND
  - PREF_OL
  type: TYPE_NORMAL
  zh: 将条件参数化为观察数据的似然函数
- en: 'Analyze the posterior using one of the options described in the previous section:'
  id: totrans-122
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用前一节描述的选项之一分析后验：
- en: Obtain a point estimate using MAP inference
  id: totrans-123
  prefs:
  - PREF_IND
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用MAP推断获取一个点估计
- en: Sample from the posterior using MCMC methods
  id: totrans-124
  prefs:
  - PREF_IND
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用MCMC方法从后验中采样
- en: Approximate the posterior using variational Bayes
  id: totrans-125
  prefs:
  - PREF_IND
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用变分贝叶斯近似后验
- en: Check your model using various diagnostic tools
  id: totrans-126
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用各种诊断工具检查您的模型
- en: Generate predictions
  id: totrans-127
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 生成预测
- en: The resulting model can be used for inference to gain detailed insights into
    parameter values, as well as to predict outcomes for new data points.
  id: totrans-128
  prefs: []
  type: TYPE_NORMAL
  zh: 生成的模型可用于推理，以获得有关参数值的详细见解，以及对新数据点的预测结果。
- en: We will illustrate this workflow using a simple logistic regression to model
    the prediction of a recession (see the notebook `pymc3_workflow`). Subsequently,
    we will use PyMC3 to compute and compare Bayesian Sharpe ratios, estimate dynamic
    pairs trading ratios, and implement Bayesian linear time-series models.
  id: totrans-129
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将使用简单的 logistic 回归来说明这个工作流程，以模拟衰退的预测（请参阅笔记本`pymc3_workflow`）。随后，我们将使用PyMC3来计算和比较贝叶斯夏普比率，估计动态配对交易比率，并实现贝叶斯线性时间序列模型。
- en: The data – leading recession indicators
  id: totrans-130
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 数据 - 领先的衰退指标
- en: 'We will use a small and simple dataset so we can focus on the workflow. We
    will use the **Federal Reserve''s Economic Data** (**FRED**) service (see *Chapter
    2*, *Market and Fundamental Data – Sources and Techniques*) to download the US
    recession dates, as defined by the **National Bureau of Economic Research** (**NBER**).
    We will also source four variables that are commonly used to predict the onset
    of a recession (Kelley 2019) and available via FRED, namely:'
  id: totrans-131
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将使用一个小型和简单的数据集，以便我们可以专注于工作流程。我们将使用**美联储经济数据**（**FRED**）服务（详见*第2章*，*市场和基本数据
    - 来源和技术*）下载由**美国经济研究局**（**NBER**）定义的美国衰退日期。我们还将获取四个通常用于预测衰退发生的变量（Kelley 2019），这些变量可以通过FRED获得，即：
- en: '**The long-term spread of the treasury yield curve**, defined as the difference
    between the 10-year and the 3-month Treasury yields'
  id: totrans-132
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**长期国债收益率曲线的传播**，定义为10年期和3个月期国债收益率之间的差异'
- en: The University of Michigan's **consumer sentiment** indicator
  id: totrans-133
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 密歇根大学的**消费者情绪**指数
- en: The **National Financial Conditions Index** (**NFCI**)
  id: totrans-134
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**全国金融状况指数**（**NFCI**）'
- en: The NFCI **nonfinancial leverage** subindex
  id: totrans-135
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: NFCI **非金融杠杆**子指数
- en: The recession dates are identified on a quarterly basis; we will resample all
    series' frequency to monthly frequency to obtain some 457 observations from 1982-2019\.
    If a quarter is labeled as a recession, we consider all months in that quarter
    as such.
  id: totrans-136
  prefs: []
  type: TYPE_NORMAL
  zh: 衰退日期以季度为基础确定；我们将重新采样所有系列的频率为每月频率，以从1982年至2019年获得大约457个观测值。如果一个季度被标记为衰退，我们将考虑该季度中的所有月份都是衰退的。
- en: 'We will build a model that intends to answer the question: **will the US economy
    be in recession x months into the future?** In other words, we do not focus on
    predicting only the first month of a recession; this limits the imbalance to 48
    recessionary months.'
  id: totrans-137
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将构建一个意图回答问题的模型：**未来 x 个月美国经济是否会陷入衰退？** 换句话说，我们不只关注预测衰退的第一个月；这限制了48个衰退月的不平衡性。
- en: 'To this end, we need to pick a lead time; plenty of research has been conducted
    into a suitable time horizon for various leading indicators: the yield curve tends
    to send signals up to 24 months ahead of a recession; the NFCI indicators tend
    to have a shorter lead time (see Kelley, 2019).'
  id: totrans-138
  prefs: []
  type: TYPE_NORMAL
  zh: 为此，我们需要选择一个先导时间；已经进行了大量研究，以找到各种领先指标的适当时间范围：收益率曲线倾向于在衰退之前提前至多24个月发送信号；NFCI 指标倾向于具有较短的先导时间（参见
    Kelley, 2019）。
- en: 'The following table largely confirms this experience: it displays the mutual
    information (see *Chapter 6*, *The Machine Learning Process*) between the binary
    recession variable and the four leading indicators for horizons from 1-24 months:'
  id: totrans-139
  prefs: []
  type: TYPE_NORMAL
  zh: 以下表格在很大程度上证实了这种经验：它显示了二元衰退变量与四个领先指标之间的互信息（参见*第6章*，*机器学习流程*）在1-24个月的时间段内的情况：
- en: '![](img/B15439_10_03.png)'
  id: totrans-140
  prefs: []
  type: TYPE_IMG
  zh: '![图](img/B15439_10_03.png)'
- en: 'Figure 10.3: Mutual information between recession and leading indicators for
    horizons from 1-24 months'
  id: totrans-141
  prefs: []
  type: TYPE_NORMAL
  zh: 图10.3：衰退与领先指标之间的互信息，时间段为1-24个月
- en: 'To strike a balance between the shorter horizon for the NFCI indicators and
    the yield curve, we will pick 12 months as our prediction horizon. The following
    plots are for the distribution of each indicator, broken down by recession status:'
  id: totrans-142
  prefs: []
  type: TYPE_NORMAL
  zh: 为了在 NFCI 指标的较短时间范围和收益率曲线之间取得平衡，我们将选择12个月作为我们的预测时间范围。 以下图表显示了每个指标的分布，按衰退状态划分：
- en: '![](img/B15439_10_04.png)'
  id: totrans-143
  prefs: []
  type: TYPE_IMG
  zh: '![图](img/B15439_10_04.png)'
- en: 'Figure 10.4: Leading indicator distributions by recession status'
  id: totrans-144
  prefs: []
  type: TYPE_NORMAL
  zh: 图10.4：按衰退状态划分的领先指标分布
- en: This shows that recessions tend to be associated with a negative long-term spread
    of the treasury yield curve, also known as an **inverted yield curve**, when short-term
    interest rates rise above long-term rates. The NFCI indicators behave as we would
    expect; the sentiment indicator appears to have the weakest association.
  id: totrans-145
  prefs: []
  type: TYPE_NORMAL
  zh: 这表明，经济衰退往往与国债收益率曲线的长期差价负相关，也被称为**倒挂收益率曲线**，当短期利率上升到长期利率之上时。 NFCI 指标的表现符合我们的预期；情绪指标似乎具有最弱的关联性。
- en: Model definition – Bayesian logistic regression
  id: totrans-146
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 模型定义 - 贝叶斯逻辑回归
- en: As discussed in *Chapter 6*, *The Machine Learning Process*, logistic regression
    estimates a linear relationship between a set of features and a binary outcome,
    mediated by a sigmoid function to ensure the model produces probabilities. The
    frequentist approach resulted in point estimates for the parameters that measure
    the influence of each feature on the probability that a data point belongs to
    the positive class, with confidence intervals based on assumptions about the parameter
    distribution.
  id: totrans-147
  prefs: []
  type: TYPE_NORMAL
  zh: 如*第6章*，*机器学习流程*中讨论的那样，逻辑回归估计了一组特征与二元结果之间的线性关系，通过一个 Sigmoid 函数进行中介，以确保模型产生概率。
    频率主义方法导致了参数的点估计，这些参数测量了每个特征对数据点属于正类的概率的影响，置信区间基于参数分布的假设。
- en: In contrast, Bayesian logistic regression estimates the posterior distribution
    over the parameters itself. The posterior allows for more robust estimates of
    what is called a **Bayesian credible interval** for each parameter, with the benefit
    of more transparency about the model's uncertainty.
  id: totrans-148
  prefs: []
  type: TYPE_NORMAL
  zh: 相比之下，贝叶斯逻辑回归估计参数本身的后验分布。 后验允许更健壮地估计每个参数的所谓**贝叶斯可信区间**，其好处在于更透明地了解模型的不确定性。
- en: A probabilistic program consists of **observed and unobserved random variables**
    (**RVs**). As discussed previously, we define the observed RVs via likelihood
    distributions and unobserved RVs via prior distributions. PyMC3 includes numerous
    probability distributions for this purpose.
  id: totrans-149
  prefs: []
  type: TYPE_NORMAL
  zh: 概率程序由**观察和未观察的随机变量**（**RVs**）组成。 正如之前讨论的，我们通过似然分布定义观察到的 RVs，通过先验分布定义未观察到的 RVs。
    PyMC3 包含许多概率分布，用于此目的。
- en: 'The PyMC3 library makes it very straightforward to perform approximate Bayesian
    inference for logistic regression. Logistic regression models the probability
    that the economy will be in recession 12 months after month *i* based on *k* features,
    as outlined on the left side of the following figure:'
  id: totrans-150
  prefs: []
  type: TYPE_NORMAL
  zh: PyMC3 库使得执行逻辑回归的近似贝叶斯推断非常简单。 逻辑回归模型基于左侧图中所述的 *k* 个特征，来建模经济在 *i* 个月后是否会陷入衰退的概率：
- en: '![](img/B15439_10_05.png)'
  id: totrans-151
  prefs: []
  type: TYPE_IMG
  zh: '![](img/B15439_10_05.png)'
- en: 'Figure 10.5: Bayesian logistic regression'
  id: totrans-152
  prefs: []
  type: TYPE_NORMAL
  zh: 图10.5：贝叶斯逻辑回归
- en: 'We will use the context manager `with` to define a `manual_logistic_model`
    that we can refer to later as a probabilistic model:'
  id: totrans-153
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将使用上下文管理器`with`来定义一个我们稍后可以引用的`manual_logistic_model`作为概率模型：
- en: The RVs for the unobserved parameters for intercept and two features are expressed
    using uninformative priors, These assume normal distributions with a mean of 0
    and a standard deviation of 100.
  id: totrans-154
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 未观测参数的RVs，用于拦截和两个特征的被表达使用不含信息的先验，这些假设正态分布的均值为0，标准差为100。
- en: The likelihood combines the parameters with the data according to the specification
    of the logistic regression.
  id: totrans-155
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 似然性根据逻辑回归的规范将参数与数据结合起来。
- en: 'The outcome is modeled as a Bernoulli RV with the success probability given
    by the likelihood:'
  id: totrans-156
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 结果被建模为具有由似然给定的成功概率的Bernoulli RV：
- en: '[PRE1]'
  id: totrans-157
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE1]'
- en: Model visualization and plate notation
  id: totrans-158
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 模型可视化和板符号
- en: The command `pm.model_to_graphviz(manual_logistic_model)` produces the plate
    notation displayed on the right in *Figure 10.5*. It shows the unobserved parameters
    as light ovals and the observed elements as dark ovals. The rectangle indicates
    the number of repetitions of the observed model element implied by the data that
    are included in the model definition.
  id: totrans-159
  prefs: []
  type: TYPE_NORMAL
  zh: 命令`pm.model_to_graphviz(manual_logistic_model)`生成右侧*图10.5*中显示的板符号。 它显示了未观察到的参数作为浅色椭圆，观察到的元素作为深色椭圆。
    矩形表示在模型定义中包含的数据暗示的观察到的模型元素的重复次数。
- en: The generalized linear models module
  id: totrans-160
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 广义线性模型模块
- en: PyMC3 includes numerous common models so that we can limit the manual specification
    for custom applications.
  id: totrans-161
  prefs: []
  type: TYPE_NORMAL
  zh: PyMC3包括许多常见的模型，以便我们可以限制自定义应用程序的手动规范。
- en: 'The following code defines the same logistic regression as a member of the
    **Generalized Linear Models** (**GLM**) family. It does so using the formula format
    inspired by the statistical language R and is ported to Python by the patsy library:'
  id: totrans-162
  prefs: []
  type: TYPE_NORMAL
  zh: 以下代码将相同的逻辑回归定义为**广义线性模型** (**GLM**)家族的成员。它使用受统计语言R启发的公式格式，并由patsy库移植到Python中：
- en: '[PRE2]'
  id: totrans-163
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: Exact MAP inference
  id: totrans-164
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 精确MAP推断
- en: 'We obtain point MAP estimates for the three parameters using the just-defined
    model''s `.find_MAP()` method. As expected, a lower spread value increases the
    recession probability, as does higher leverage (but to a lesser extent):'
  id: totrans-165
  prefs: []
  type: TYPE_NORMAL
  zh: 我们使用刚刚定义的模型的`.find_MAP()`方法获得三个参数的点MAP估计。 如预期的那样，较低的展开值增加了衰退的概率，较高的杠杆(但程度较小)也是如此：
- en: '[PRE3]'
  id: totrans-166
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: PyMC3 solves the optimization problem of finding the posterior point with the
    highest density using the quasi-Newton **Broyden-Fletcher-Goldfarb-Shanno** (**BFGS**)
    algorithm, but offers several alternatives provided by the SciPy library.
  id: totrans-167
  prefs: []
  type: TYPE_NORMAL
  zh: PyMC3使用拟牛顿**Broyden-Fletcher-Goldfarb-Shanno** (**BFGS**)算法解决找到具有最高密度的后验点的优化问题，但提供了SciPy库提供的几种替代方案。
- en: The MAP point estimates are identical to the corresponding `statsmodels` coefficients
    (see the notebook `pymc3_workflow`).
  id: totrans-168
  prefs: []
  type: TYPE_NORMAL
  zh: MAP点估计与相应的`statsmodels`系数相同(请参阅笔记本`pymc3_workflow`)。
- en: Approximate inference – MCMC
  id: totrans-169
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 近似推断 – MCMC
- en: If we are only interested in point estimates for the model parameters, then
    for this simple model, the MAP estimate would be sufficient. More complex, custom
    probabilistic models require sampling techniques to obtain a posterior probability
    for the parameters.
  id: totrans-170
  prefs: []
  type: TYPE_NORMAL
  zh: 如果我们只对模型参数的点估计感兴趣，那么对于这个简单模型来说，MAP估计就足够了。 更复杂的自定义概率模型需要采样技术以获得参数的后验概率。
- en: 'We will use the model with all its variables to illustrate MCMC inference:'
  id: totrans-171
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将使用所有变量的模型来说明MCMC推断：
- en: '[PRE4]'
  id: totrans-172
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: Note that variables measured on very different scales can slow down the sampling
    process. Hence, we first apply the `scale()` function provided by scikit-learn
    to standardize all features.
  id: totrans-173
  prefs: []
  type: TYPE_NORMAL
  zh: 请注意，测量在非常不同尺度上的变量可能会减慢采样过程。 因此，我们首先应用由scikit-learn提供的`scale()`函数来标准化所有特征。
- en: Once we have defined our model like this with the new formula, we are ready
    to perform inference to approximate the posterior distribution. MCMC sampling
    algorithms are available through the `pm.sample()` function.
  id: totrans-174
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦我们用新的公式定义了我们的模型，我们就可以执行推断以近似后验分布。 MCMC采样算法可通过`pm.sample()`函数获得。
- en: By default, PyMC3 automatically selects the most efficient sampler and initializes
    the sampling process for efficient convergence. For a continuous model, PyMC3
    chooses the NUTS sampler discussed in the previous section. It also runs variational
    inference via ADVI to find good starting parameters for the sampler. One among
    several alternatives is to use the MAP estimate.
  id: totrans-175
  prefs: []
  type: TYPE_NORMAL
  zh: 默认情况下，PyMC3 自动选择最有效的采样器并初始化采样过程以实现高效收敛。对于连续模型，PyMC3 选择在前一节中讨论的 NUTS 采样器。它还通过
    ADVI 运行变分推断以找到采样器的良好起始参数。其中一种替代方法是使用 MAP 估计。
- en: 'To see what convergence looks like, we first draw only 100 samples after tuning
    the sampler for 1,000 iterations. These will be discarded. The sampling process
    can be parallelized for multiple chains using the `cores` argument (except when
    using GPU):'
  id: totrans-176
  prefs: []
  type: TYPE_NORMAL
  zh: 要了解收敛的情况，我们首先在调整采样器 1,000 次迭代后只绘制 100 个样本。这些将被丢弃。可以使用`cores`参数（除了使用 GPU 时）将采样过程并行化为多个链：
- en: '[PRE5]'
  id: totrans-177
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: 'The resulting `trace` contains the sampled values for each RV. We can inspect
    the posterior distribution of the chains using the `plot_traces()` function:'
  id: totrans-178
  prefs: []
  type: TYPE_NORMAL
  zh: 结果的`trace`包含每个 RV 的采样值。我们可以使用`plot_traces()`函数检查链的后验分布。
- en: '[PRE6]'
  id: totrans-179
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: '*Figure 10.6* shows both the sample distribution and their values over time
    for the first two features and the intercept (see the notebook for the full output).
    At this point, the sampling process has not converged since for each of the features,
    the four traces yield quite different results; the numbers shown vertically in
    the left five panels are the averages of the modes of the distributions generated
    by the four traces:'
  id: totrans-180
  prefs: []
  type: TYPE_NORMAL
  zh: '*图 10.6*显示了前两个特征和截距的样本分布及其随时间的值（请参阅笔记本以获取完整输出）。此时，采样过程尚未收敛，因为对于每个特征，四条轨迹产生了完全不同的结果；左侧五个面板中垂直显示的数字是由四条轨迹生成的分布的模式的平均值：'
- en: '![](img/B15439_10_06.png)'
  id: totrans-181
  prefs: []
  type: TYPE_IMG
  zh: '![](img/B15439_10_06.png)'
- en: 'Figure 10.6: Traces after 100 samples'
  id: totrans-182
  prefs: []
  type: TYPE_NORMAL
  zh: 图 10.6：100 个样本后的轨迹
- en: 'We can continue sampling by providing the trace of a prior run as input. After
    an additional 20,000 samples, we observe a much different picture, as shown in
    the following figure. This shows how the sampling process is now much closer to
    convergence. Also, note that the initial coefficient point estimates were relatively
    close to the current values:'
  id: totrans-183
  prefs: []
  type: TYPE_NORMAL
  zh: 我们可以通过提供先前运行的迹作为输入来继续采样。额外 20,000 个样本后，我们观察到一个非常不同的图像，如下图所示。这显示了采样过程现在更接近收敛。还要注意，初始系数点估计值与当前值相对较接近：
- en: '![](img/B15439_10_07.png)'
  id: totrans-184
  prefs: []
  type: TYPE_IMG
  zh: '![](img/B15439_10_07.png)'
- en: 'Figure 10.7: Traces after an additional 50,000 samples'
  id: totrans-185
  prefs: []
  type: TYPE_NORMAL
  zh: 图 10.7：额外 50,000 个样本后的轨迹
- en: We can compute the **credible intervals**, the Bayesian counterpart of confidence
    intervals, as percentiles of the trace. The resulting boundaries reflect our confidence
    about the range of the parameter value for a given probability threshold, as opposed
    to the number of times the parameter will be within this range for a large number
    of trials. *Figure 10.8* shows the credible intervals for the variables' yield
    curve and leverage, expressed in terms of the odds ratio that results from raising
    *e* to the power of the coefficient value (see *Chapter 7*, *Linear Models – From
    Risk Factors to Return Forecasts*).
  id: totrans-186
  prefs: []
  type: TYPE_NORMAL
  zh: 我们可以计算**可信区间**，即贝叶斯区间估计的对应物，作为迹的百分位数。结果边界反映了我们对于给定概率阈值的参数值范围的置信度，而不是参数在大量试验中在此范围内的次数。*图
    10.8*显示了变量的收益曲线和杠杆的可信区间，以系数值的指数函数（参见*第 7 章*，*线性模型 - 从风险因素到收益预测*）来表示。
- en: 'See the notebook `pymc3_workflow` for the implementation:'
  id: totrans-187
  prefs: []
  type: TYPE_NORMAL
  zh: 请参阅笔记本`pymc3_workflow`的实现：
- en: '![](img/B15439_10_08.png)'
  id: totrans-188
  prefs: []
  type: TYPE_IMG
  zh: '![](img/B15439_10_08.png)'
- en: 'Figure 10.8: Credible intervals for yield curve and leverage'
  id: totrans-189
  prefs: []
  type: TYPE_NORMAL
  zh: 图 10.8：收益曲线和杠杆的可信区间
- en: Approximate inference – variational Bayes
  id: totrans-190
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 近似推断 - 变分贝叶斯
- en: 'The interface for variational inference is very similar to the MCMC implementation.
    We just use `fit()` instead of the `sample()` function, with the option to include
    an early stopping `CheckParametersConvergence` callback if the distribution-fitting
    process converges up to a given tolerance:'
  id: totrans-191
  prefs: []
  type: TYPE_NORMAL
  zh: 变分推断的接口与 MCMC 实现非常相似。我们只是使用`fit()`而不是`sample()`函数，可以选择包括一个早期停止的`CheckParametersConvergence`回调，如果分布拟合过程收敛到给定的容差：
- en: '[PRE7]'
  id: totrans-192
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: 'We can draw samples from the approximated distribution to obtain a trace object,
    as we did previously for the MCMC sampler:'
  id: totrans-193
  prefs: []
  type: TYPE_NORMAL
  zh: 我们可以从近似分布中抽取样本以获得一个迹对象，就像我们之前为 MCMC 采样器所做的那样：
- en: '[PRE8]'
  id: totrans-194
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: Inspection of the trace summary shows that the results are slightly less accurate.
  id: totrans-195
  prefs: []
  type: TYPE_NORMAL
  zh: 检查跟踪摘要显示结果稍微不太准确。
- en: Model diagnostics
  id: totrans-196
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 模型诊断
- en: Bayesian model diagnostics includes validating that the sampling process has
    converged and consistently samples from high-probability areas of the posterior,
    as well as confirming that the model represents the data well.
  id: totrans-197
  prefs: []
  type: TYPE_NORMAL
  zh: 贝叶斯模型诊断包括验证采样过程是否收敛并且是否一直从后验的高概率区域进行采样，以及确认模型是否很好地表示了数据。
- en: Convergence
  id: totrans-198
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 收敛性
- en: 'We can visualize the samples over time and their distributions to check the
    quality of the results. The charts shown in the following image show the posterior
    distributions after an initial 100 and an additional 200,000 samples, respectively,
    and illustrate how convergence implies that multiple chains identify the same
    distribution:'
  id: totrans-199
  prefs: []
  type: TYPE_NORMAL
  zh: 我们可以通过随时间变化的样本和它们的分布来可视化结果的质量。下图显示了初始100个样本和额外的200,000个样本后的后验分布，说明了收敛意味着多个链识别相同的分布：
- en: '![](img/B15439_10_09.png)'
  id: totrans-200
  prefs: []
  type: TYPE_IMG
  zh: '![](img/B15439_10_09.png)'
- en: 'Figure 10.9: Traces after 400 and after over 200,000 samples'
  id: totrans-201
  prefs: []
  type: TYPE_NORMAL
  zh: 图10.9：400个样本后和超过200,000个样本后的跟踪
- en: PyMC3 produces various summary statistics for a sampler. These are available
    as individual functions in the stats module, or by providing a trace to the function
    `pm.summary()`.
  id: totrans-202
  prefs: []
  type: TYPE_NORMAL
  zh: PyMC3为采样器生成各种摘要统计信息。这些信息可以作为统计模块中的单独函数提供，也可以通过将追踪传递给函数`pm.summary()`来获取。
- en: 'The following table includes the (separately computed) statsmodels logit coefficients
    in the first column to show that, in this simple case, both models slightly agree
    because the sample mean does not match the coefficients. This is likely due to
    the high degree of quasi-separation: the yield curve''s high predictability allows
    for the perfect prediction of 17 percent of the data points, which, in turn, leads
    to poorly defined MLE estimates for the logistic regression (see the statsmodels
    output in the notebook for more information):'
  id: totrans-203
  prefs: []
  type: TYPE_NORMAL
  zh: 下表包含（分别计算的）statsmodels逻辑斯蒂回归系数作为第一列，以显示在这种简单情况下，两个模型略有一致，因为样本均值与系数不匹配。这很可能是由于准分离的高程度造成的：收益率曲线的高可预测性允许对17%的数据点进行完美预测，这反过来导致逻辑回归的最大似然估计定义不清晰（有关更多信息，请参见笔记本中的statsmodels输出）。
- en: '| Parameters | statsmodels | PyMC3 |'
  id: totrans-204
  prefs: []
  type: TYPE_TB
  zh: '| 参数 | statsmodels | PyMC3 |'
- en: '| Coefficients | Mean | SD | HPD 3% | HPD 97% | Effective Samples | R hat |'
  id: totrans-205
  prefs: []
  type: TYPE_TB
  zh: '| 系数 | 均值 | 标准差 | HPD 3% | HPD 97% | 有效样本 | R hat |'
- en: '| Intercept | -5.22 | -5.47 | 0.71 | -6.82 | -4.17 | 68,142 | 1.00 |'
  id: totrans-206
  prefs: []
  type: TYPE_TB
  zh: '| 截距 | -5.22 | -5.47 | 0.71 | -6.82 | -4.17 | 68,142 | 1.00 |'
- en: '| yield_curve | -3.30 | -3.47 | 0.51 | -4.44 | -2.55 | 70,479 | 1.00 |'
  id: totrans-207
  prefs: []
  type: TYPE_TB
  zh: '| 收益率曲线 | -3.30 | -3.47 | 0.51 | -4.44 | -2.55 | 70,479 | 1.00 |'
- en: '| leverage | 1.98 | 2.08 | 0.40 | 1.34 | 2.83 | 72,639 | 1.00 |'
  id: totrans-208
  prefs: []
  type: TYPE_TB
  zh: '| 杠杆 | 1.98 | 2.08 | 0.40 | 1.34 | 2.83 | 72,639 | 1.00 |'
- en: '| financial_conditions | -0.65 | -0.70 | 0.33 | -1.33 | -0.07 | 91,104 | 1.00
    |'
  id: totrans-209
  prefs: []
  type: TYPE_TB
  zh: '| 金融条件 | -0.65 | -0.70 | 0.33 | -1.33 | -0.07 | 91,104 | 1.00 |'
- en: '| sentiment | -0.33 | -0.34 | 0.26 | -0.82 | 0.15 | 106,751 | 1.00 |'
  id: totrans-210
  prefs: []
  type: TYPE_TB
  zh: '| 情绪 | -0.33 | -0.34 | 0.26 | -0.82 | 0.15 | 106,751 | 1.00 |'
- en: The remaining columns contain the **highest posterior density** (**HPD**) estimate
    for the minimum width credible interval, the Bayesian version of a confidence
    interval, which, here, is computed at the 95 percent level. The `n_eff` statistic
    summarizes the number of effective (not rejected) samples resulting from the ![](img/B15439_10_009.png)
    draws.
  id: totrans-211
  prefs: []
  type: TYPE_NORMAL
  zh: 剩余列包含最高后验密度（**HPD**）估计的最小宽度可信区间，这是置信区间的贝叶斯版本，此处计算为95%的水平。`n_eff`统计量总结了从![](img/B15439_10_009.png)绘制的有效（未被拒绝）样本数量。
- en: R-hat, also known as the **Gelman-Rubin statistic**, checks convergence by comparing
    the variance between chains to the variance within each chain. If the sampler
    converged, these variances should be identical, that is, the chains should look
    similar. Hence, the statistic should be near 1.
  id: totrans-212
  prefs: []
  type: TYPE_NORMAL
  zh: R-hat，也被称为**Gelman-Rubin统计量**，通过比较链间方差和链内方差来检查收敛性。如果采样器收敛了，这些方差应该相同，即链应该看起来相似。因此，该统计量应接近1。
- en: 'For high-dimensional models with many variables, it becomes cumbersome to inspect
    numerous traces. When using NUTS, the energy plot helps us assess problems of
    convergence. It summarizes how efficiently the random process explores the posterior.
    The plot shows the energy and the energy transition matrix, which should be well
    matched, as in the example shown in the right-hand panel of the following image:'
  id: totrans-213
  prefs: []
  type: TYPE_NORMAL
  zh: 对于具有许多变量的高维模型，检查大量的跟踪变得很麻烦。在使用NUTS时，能量图帮助我们评估收敛问题。它总结了随机过程探索后验的效率。图表显示了能量和能量转换矩阵，它们应该匹配良好，就像下图右侧面板中显示的例子一样：
- en: '![](img/B15439_10_10.png)'
  id: totrans-214
  prefs: []
  type: TYPE_IMG
  zh: '![](img/B15439_10_10.png)'
- en: 'Figure 10.10: Forest and energy plot'
  id: totrans-215
  prefs: []
  type: TYPE_NORMAL
  zh: '图10.10: 森林和能量图'
- en: Posterior predictive checks
  id: totrans-216
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 后验预测检查
- en: '**Posterior predictive checks** (**PPCs**) are very useful for examining how
    well a model fits the data. They do so by generating data from the model using
    parameters from draws from the posterior. We use the function `pm.sample_ppc`
    for this purpose and obtain *n* samples for each observation (the GLM module automatically
    names the outcome `''y''`):'
  id: totrans-217
  prefs: []
  type: TYPE_NORMAL
  zh: '**后验预测检查** (**PPCs**) 对于检查模型与数据拟合程度非常有用。它们通过使用从后验抽取的参数从模型生成数据来实现这一点。我们使用函数
    `pm.sample_ppc` 来实现此目的，并为每个观测值获取 *n* 个样本（GLM 模块自动将结果命名为 `''y''`）：'
- en: '[PRE9]'
  id: totrans-218
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: 'We can evaluate the in-sample fit using the area under the receiver-operating
    characteristic curve (AUC, see *Chapter 6*, *The Machine Learning Process*) score
    to, for example, compare different models:'
  id: totrans-219
  prefs: []
  type: TYPE_NORMAL
  zh: 我们可以使用接收器操作特征曲线下面积（AUC，参见*第6章*，*机器学习过程*）得分来评估样本内适配度，例如，比较不同的模型：
- en: '[PRE10]'
  id: totrans-220
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: The result is fairly high at almost 0.95.
  id: totrans-221
  prefs: []
  type: TYPE_NORMAL
  zh: 结果相当高，几乎为 0.95。
- en: How to generate predictions
  id: totrans-222
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 如何生成预测
- en: Predictions use Theano's *shared variables* to replace the training data with
    test data before running posterior predictive checks. To allow for visualization
    and to simplify the exposition, we use the yield curve variable as the only predictor
    and ignore the time-series nature of our data.
  id: totrans-223
  prefs: []
  type: TYPE_NORMAL
  zh: 预测使用 Theano 的 *共享变量* 来在运行后验预测检查之前用测试数据替换训练数据。为了可视化和简化表述，我们使用收益曲线变量作为唯一的预测变量，并忽略我们数据的时间序列特性。
- en: 'Instead, we create the train and test sets using scikit-learn''s basic `train_test_split()`
    function, stratified by the outcome, to maintain the class imbalance:'
  id: totrans-224
  prefs: []
  type: TYPE_NORMAL
  zh: 相反，我们使用 scikit-learn 的基本 `train_test_split()` 函数创建训练集和测试集，通过结果进行分层，以保持类别不平衡：
- en: '[PRE11]'
  id: totrans-225
  prefs: []
  type: TYPE_PRE
  zh: '[PRE11]'
- en: 'We then create a shared variable for that training set, which we replace with
    the test set in the next step. Note that we need to use NumPy arrays and provide
    a list of column labels:'
  id: totrans-226
  prefs: []
  type: TYPE_NORMAL
  zh: 然后我们为该训练集创建一个共享变量，然后在下一步中用测试集替换它。请注意，我们需要使用 NumPy 数组并提供列标签的列表：
- en: '[PRE12]'
  id: totrans-227
  prefs: []
  type: TYPE_PRE
  zh: '[PRE12]'
- en: 'We then run the sampler, as we did previously:'
  id: totrans-228
  prefs: []
  type: TYPE_NORMAL
  zh: 然后我们像之前一样运行采样器：
- en: '[PRE13]'
  id: totrans-229
  prefs: []
  type: TYPE_PRE
  zh: '[PRE13]'
- en: 'Now, we substitute the test data for the train data on the shared variable
    and apply the `pm.sample_ppc` function to the resulting `trace`:'
  id: totrans-230
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，我们将测试数据替换为共享变量上的训练数据，并将 `pm.sample_ppc` 函数应用于生成的 `trace`：
- en: '[PRE14]'
  id: totrans-231
  prefs: []
  type: TYPE_PRE
  zh: '[PRE14]'
- en: The AUC score for this simple model is 0.86\. Clearly, it is much easier to
    predict the same recession for another month if the training set already includes
    examples of this recession from nearby months. Keep in mind that we are using
    this model for demonstration purposes only.
  id: totrans-232
  prefs: []
  type: TYPE_NORMAL
  zh: 这个简单模型的 AUC 分数是 0.86。显然，如果训练集已经包含了来自附近月份的衰退示例，那么对于另一个月份预测相同的衰退要容易得多。请记住，我们仅用于演示目的使用此模型。
- en: '*Figure 10.11* plots the predictions that were sampled from the 100 Monte Carlo
    chain and the uncertainty surrounding them, as well as the actual binary outcomes
    and the logistic curve corresponding to the model predictions:'
  id: totrans-233
  prefs: []
  type: TYPE_NORMAL
  zh: '*图10.11* 绘制了从 100 个 Monte Carlo 链中抽样的预测及其周围的不确定性，以及实际的二元结果和对应于模型预测的 logistic
    曲线：'
- en: '![](img/B15439_10_11.png)'
  id: totrans-234
  prefs: []
  type: TYPE_IMG
  zh: '![](img/B15439_10_11.png)'
- en: 'Figure 10.11: Single-variable model predictions'
  id: totrans-235
  prefs: []
  type: TYPE_NORMAL
  zh: '图10.11: 单变量模型预测'
- en: Summary and key takeaways
  id: totrans-236
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 摘要和主要观点
- en: We have built a simple logistic regression model to predict the probability
    that the US economy will be in recession in 12 months using four leading indicators.
    For this simple model, we could get exact MAP estimates of the coefficient values,
    which we could then use to parameterize the model and make predictions.
  id: totrans-237
  prefs: []
  type: TYPE_NORMAL
  zh: 我们建立了一个简单的 logistic 回归模型，用于预测美国经济在 12 个月内陷入衰退的概率，使用了四个领先指标。对于这个简单模型，我们可以得到精确的
    MAP 估计系数值，然后使用这些系数值对模型进行参数化和预测。
- en: However, more complex, custom probability models will not allow for this shortcut,
    and MAP estimates also do not generate insight into the posterior distribution
    beyond the point estimate. For this reason, we demonstrated how to run approximate
    inference using PyMC3\. The results illustrated how we learn about the posterior
    distribution for each of the model parameters, but also showed that even for a
    small model, the computational cost increases considerably compared to statsmodels
    MLE estimates. Nonetheless, for sophisticated probabilistic models, sampling-based
    solutions are the only way to learn about the data.
  id: totrans-238
  prefs: []
  type: TYPE_NORMAL
  zh: 但是，更复杂的自定义概率模型将不允许此捷径，而且MAP估计也不会生成有关点估计之外的后验分布的洞见。因此，我们演示了如何使用PyMC3进行近似推理。结果说明了我们如何了解每个模型参数的后验分布，但也显示出即使对于一个小模型，与statsmodels
    MLE估计相比，计算成本也会显著增加。尽管如此，对于复杂的概率模型，基于采样的解决方案是了解数据的唯一途径。
- en: We will now proceed to illustrate how to apply Bayesian analysis to some trading-related
    use cases.
  id: totrans-239
  prefs: []
  type: TYPE_NORMAL
  zh: 我们现在将说明如何将贝叶斯分析应用于一些与交易相关的用例。
- en: Bayesian ML for trading
  id: totrans-240
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 交易的贝叶斯机器学习
- en: 'Now that we are familiar with the Bayesian approach to ML and probabilistic
    programming with PyMC3, let''s explore a few relevant trading-related applications,
    namely:'
  id: totrans-241
  prefs: []
  type: TYPE_NORMAL
  zh: 既然我们熟悉了ML和用PyMC3进行概率编程的贝叶斯方法，让我们探讨一下几个相关的交易应用，即：
- en: Modeling the Sharpe ratio as a probabilistic model for more insightful performance
    comparison
  id: totrans-242
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 将夏普比率建模为更具洞察力的性能比较的概率模型
- en: Computing pairs trading hedge ratios using Bayesian linear regression
  id: totrans-243
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用贝叶斯线性回归计算配对交易对冲比率
- en: Analyzing linear time series models from a Bayesian perspective
  id: totrans-244
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 从贝叶斯角度分析线性时间序列模型
- en: '**Thomas Wiecki**, one of the main PyMC3 authors who also leads Data Science
    at Quantopian, has created several examples that the following sections follow
    and build on. The PyMC3 documentation has many additional tutorials (see GitHub
    for links).'
  id: totrans-245
  prefs: []
  type: TYPE_NORMAL
  zh: '**托马斯·韦基**，PyMC3的主要作者之一，也是Quantopian的数据科学主管，已经创建了几个示例，以下各节将继续并在其基础上建立。PyMC3文档有许多额外的教程（请查看GitHub获取链接）。'
- en: Bayesian Sharpe ratio for performance comparison
  id: totrans-246
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 用于性能比较的贝叶斯夏普比率
- en: 'In this section, we will illustrate:'
  id: totrans-247
  prefs: []
  type: TYPE_NORMAL
  zh: 在本节中，我们将说明：
- en: How to define the **Sharpe Ratio** (**SR**) as a probabilistic model using PyMC3
  id: totrans-248
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 如何使用PyMC3定义**夏普比率**（**SR**）作为概率模型
- en: How to compare its posterior distributions for different return series
  id: totrans-249
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 如何比较不同回报序列的后验分布
- en: The Bayesian estimation for two series offers very rich insights because it
    provides the complete distributions of the credible values for the effect size,
    the group SR means and their difference, as well as standard deviations and their
    difference. The Python implementation is due to Thomas Wiecki and was inspired
    by the R package BEST (Meredith and Kruschke, 2018).
  id: totrans-250
  prefs: []
  type: TYPE_NORMAL
  zh: 为两个序列进行贝叶斯估计提供了非常丰富的见解，因为它提供了效应大小，组SR均值及其差异的可信值的完整分布，以及标准偏差及其差异的完整分布。Python实现是由Thomas
    Wiecki完成的，并受到了R包BEST（Meredith和Kruschke，2018）的启发。
- en: Relevant use cases of a Bayesian SR include the analysis of differences between
    alternative strategies, or between a strategy's in-sample return and its out-of-sample
    return (see the notebook `bayesian_sharpe_ratio` for details). The Bayesian SR
    is also part of pyfolio's Bayesian tearsheet.
  id: totrans-251
  prefs: []
  type: TYPE_NORMAL
  zh: 使用贝叶斯SR的相关用例包括分析替代策略之间的差异，或者策略的样本内回报与样本外回报之间的差异（详见笔记本`bayesian_sharpe_ratio`）。贝叶斯SR也是pyfolio的贝叶斯信息单页的一部分。
- en: Defining a custom probability model
  id: totrans-252
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 定义一个自定义的概率模型
- en: To model the SR as a probabilistic model, we need the priors about the distribution
    of returns and the parameters that govern this distribution. The Student t distribution
    exhibits fat tails relative to the normal distribution for low **degrees of freedom**
    (**DF**), and is a reasonable choice to capture this aspect of returns.
  id: totrans-253
  prefs: []
  type: TYPE_NORMAL
  zh: 要将SR建模为概率模型，我们需要关于回报分布及其控制此分布的参数的先验。相对于低**自由度**（**DF**）的正态分布，学生t分布具有较厚的尾部，是捕获回报此方面的合理选择。
- en: We thus need to **model the three parameters of this distribution**, namely
    the mean and standard deviation of returns, and the DF. We'll assume normal and
    uniform distributions for the mean and the standard deviation, respectively, and
    an exponential distribution for the DF with a sufficiently low expected value
    to ensure fat tails.
  id: totrans-254
  prefs: []
  type: TYPE_NORMAL
  zh: 因此，我们需要**对此分布的三个参数进行建模**，即回报的均值和标准偏差，以及DF。我们将假设对于均值和标准偏差，分别采用正态和均匀分布，对于DF采用指数分布，期望值足够低以确保尾部较厚。
- en: 'The returns are based on these probabilistic inputs, and the annualized SR
    results from the standard computation, ignoring a risk-free rate (using daily
    returns). We will provide AMZN stock returns from 2010-2018 as input (see the
    notebook for more on data preparation):'
  id: totrans-255
  prefs: []
  type: TYPE_NORMAL
  zh: 这些概率输入是基于这些回报的，而年化SR来自标准计算，忽略无风险利率（使用每日回报）。我们将提供2010-2018年的AMZN股票回报作为输入（有关数据准备的更多信息，请参阅笔记本）：
- en: '[PRE15]'
  id: totrans-256
  prefs: []
  type: TYPE_PRE
  zh: '[PRE15]'
- en: 'The plate notation, which we introduced in the previous section on the PyMC3
    workflow, visualizes the three parameters and their relationships, along with
    the returns and the number of observations we provided in the following diagram:'
  id: totrans-257
  prefs: []
  type: TYPE_NORMAL
  zh: 板符号，我们在关于PyMC3工作流程的上一节中引入的，可视化了三个参数及其关系，以及我们在以下图中提供的回报和观察次数：
- en: '![](img/B15439_10_12.png)'
  id: totrans-258
  prefs: []
  type: TYPE_IMG
  zh: '![](img/B15439_10_12.png)'
- en: 'Figure 10.12: The Bayesian SR in plate notation'
  id: totrans-259
  prefs: []
  type: TYPE_NORMAL
  zh: 图10.12：贝叶斯SR在板符号中
- en: 'We then run the MCMC sampling process we introduced in the previous section
    (see the notebook `bayesian_sharpe_ratio` for the implementation details that
    follow the familiar workflow). After some 25,000 samples for each of four chains,
    we obtain the posterior distributions for the model parameters as follows, with
    the results appearing in the following plots:'
  id: totrans-260
  prefs: []
  type: TYPE_NORMAL
  zh: 然后我们运行我们在前一节介绍的MCMC抽样过程（请参阅笔记本`bayesian_sharpe_ratio`以了解随后的实现细节）。经过约25000次对四个链的抽样后，我们获得了模型参数的后验分布，结果显示在以下图中：
- en: '[PRE16]'
  id: totrans-261
  prefs: []
  type: TYPE_PRE
  zh: '[PRE16]'
- en: '![](img/B15439_10_13.png)'
  id: totrans-262
  prefs: []
  type: TYPE_IMG
  zh: '![](img/B15439_10_13.png)'
- en: 'Figure 10.13: The posterior distribution for the model parameters'
  id: totrans-263
  prefs: []
  type: TYPE_NORMAL
  zh: 图10.13：模型参数的后验分布
- en: Now that we know how to evaluate the SR for a single asset or portfolio, let's
    see how we can compare the performance of two different return series using the
    Bayesian SR.
  id: totrans-264
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们知道如何评估单个资产或投资组合的SR，让我们看看如何使用贝叶斯SR来比较两个不同回报序列的性能。
- en: Comparing the performance of two return series
  id: totrans-265
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 比较两个回报序列的性能
- en: 'To compare the performance of two return series, we will model each group''s
    SR separately and compute the effect size as the difference between the volatility-adjusted
    returns. The corresponding probability model, displayed in the following diagram,
    is naturally larger because it includes two SRs, plus their difference:'
  id: totrans-266
  prefs: []
  type: TYPE_NORMAL
  zh: 为了比较两个回报序列的性能，我们将分别对每个组的SR进行建模，并将效应大小计算为波动率调整后回报之间的差异。以下图表显示的相应概率模型自然更大，因为它包括两个SR以及它们的差异：
- en: '![](img/B15439_10_14.png)'
  id: totrans-267
  prefs: []
  type: TYPE_IMG
  zh: '![](img/B15439_10_14.png)'
- en: 'Figure 10.14: The difference between two Bayesian SRs in plate notation'
  id: totrans-268
  prefs: []
  type: TYPE_NORMAL
  zh: 图10.14：在板符号中两个贝叶斯SR之间的差异
- en: Once we have defined the model, we run it through the MCMC sampling process
    to obtain the posterior distribution for its parameters. We use 2,037 daily returns
    for the AMZN stock 2010-2018 and compare it with S&P 500 returns for the same
    period. We could use the returns on any of our strategy backtests instead of the
    AMZN returns.
  id: totrans-269
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦我们定义了模型，我们就通过MCMC抽样过程运行它以获得其参数的后验分布。我们使用2010-2018年的2,037个每日回报来比较AMZN股票与同一时期的标普500指数回报。我们可以使用我们任何策略回测的回报，而不是AMZN的回报。
- en: 'Visualizing the traces reveals granular performance insights into the distributions
    of each metric, as illustrated by the various plots in *Figure 10.15*:'
  id: totrans-270
  prefs: []
  type: TYPE_NORMAL
  zh: 可视化轨迹揭示了对每个指标分布的精细性能洞察，如*图10.15*中的各种图表所示：
- en: '![](img/B15439_10_15.png)'
  id: totrans-271
  prefs: []
  type: TYPE_IMG
  zh: '![](img/B15439_10_15.png)'
- en: 'Figure 10.15: The posterior distributions for the differences between two Bayesian
    SRs'
  id: totrans-272
  prefs: []
  type: TYPE_NORMAL
  zh: 图10.15：两个贝叶斯SR之间的后验分布
- en: The most important metric is the difference between the two SRs in the bottom
    panel. Given the full posterior distribution, it is straightforward to visualize
    or compute the probability that one return series is superior from an SR perspective.
  id: totrans-273
  prefs: []
  type: TYPE_NORMAL
  zh: 最重要的度量标准是底部面板中两个SR之间的差异。给定完整的后验分布，可以直观地可视化或计算从SR角度来看一个回报序列优越的概率。
- en: Bayesian rolling regression for pairs trading
  id: totrans-274
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 用于配对交易的贝叶斯滚动回归
- en: In the previous chapter, we introduced pairs trading as a popular trading strategy
    that relies on the cointegration of two or more assets. Given such assets, we
    need to estimate the hedging ratio to decide on the relative magnitude of long
    and short positions. A basic approach uses linear regression. You can find the
    code for this section in the notebook `rolling_regression`, which follows Thomas
    Wiecki's rolling regression example (see the link to the PyMC3 tutorials on GitHub).
  id: totrans-275
  prefs: []
  type: TYPE_NORMAL
  zh: 在前一章中，我们介绍了配对交易作为一种流行的交易策略，它依赖于两个或更多资产的协整性。 鉴于这样的资产，我们需要估计对冲比率，以决定多头和空头位置的相对大小。
    一种基本方法使用线性回归。 你可以在笔记本`rolling_regression`中找到此部分的代码，该笔记本遵循了托马斯·威克（Thomas Wiecki）的滚动回归示例（请参阅GitHub上PyMC3教程的链接）。
- en: 'A popular example of pairs trading candidates is ETF GLD, which reflects the
    gold price and a gold mining stock like GFI. We source the close price data using
    yfinance for the 2004-2020 period. The left panel of *Figure 10.16* shows the
    historical price series, while the right panel shows a scatter plot of historical
    prices, where the hue indicates the time dimension to highlight how the correlation
    appears to have been evolving. **Note that we should be using the returns**, as
    we did in *Chapter 9*, *Time-Series Models for Volatility Forecasts and Statistical
    Arbitrage*, to compute the hedge ratio; however, using the prices series creates
    more striking visualizations. The modeling process itself remains unaffected:'
  id: totrans-276
  prefs: []
  type: TYPE_NORMAL
  zh: 配对交易候选资产的一个流行示例是ETF GLD，它反映了金价和像GFI这样的金矿股票。 我们使用yfinance获取2004年至2020年期间的收盘价数据。
    *图 10.16*的左侧面板显示了历史价格序列，而右侧面板显示了历史价格的散点图，其中色调表示时间维度，以突出显示相关性的演变方式。 **注意我们应该使用收益率**，就像我们在*第9章*，*波动率预测和统计套利的时间序列模型*中所做的那样，来计算对冲比率;
    然而，使用价格序列创建更引人注目的可视化效果。 建模过程本身保持不变：
- en: '![](img/B15439_10_16.png)'
  id: totrans-277
  prefs: []
  type: TYPE_IMG
  zh: '![](img/B15439_10_16.png)'
- en: 'Figure 10.16: Price series and correlation over time of two pairs of trading
    candidates'
  id: totrans-278
  prefs: []
  type: TYPE_NORMAL
  zh: 图 10.16：两对交易候选资产的价格序列和随时间的相关性
- en: 'We want to illustrate how a rolling Bayesian linear regression can track changes
    in the relationship between the prices of the two assets over time. The main idea
    is to incorporate the time dimension into a linear regression by allowing for
    changes in the regression coefficients. Specifically, we will assume that intercept
    and slope follow a random walk through time:'
  id: totrans-279
  prefs: []
  type: TYPE_NORMAL
  zh: 我们想说明滚动贝叶斯线性回归如何随时间跟踪两个资产价格之间关系的变化。 主要思想是通过允许回归系数的变化将时间维度纳入线性回归中。 具体来说，我们将假设截距和斜率随时间呈随机游走：
- en: '![](img/B15439_10_010.png)'
  id: totrans-280
  prefs: []
  type: TYPE_IMG
  zh: '![](img/B15439_10_010.png)'
- en: 'We specify `model_randomwalk` using PyMC3''s built-in `pm.GaussianRandomWalk`
    process. It requires us to define a standard deviation for both intercept alpha
    and slope beta:'
  id: totrans-281
  prefs: []
  type: TYPE_NORMAL
  zh: 我们使用PyMC3内置的`pm.GaussianRandomWalk`过程指定`model_randomwalk`。 它要求我们为截距alpha和斜率beta都定义标准差：
- en: '[PRE17]'
  id: totrans-282
  prefs: []
  type: TYPE_PRE
  zh: '[PRE17]'
- en: 'Given the specification of the probabilistic model, we will now define the
    regression and connect it to the input data:'
  id: totrans-283
  prefs: []
  type: TYPE_NORMAL
  zh: 鉴于概率模型的规范，我们现在将定义回归并将其连接到输入数据：
- en: '[PRE18]'
  id: totrans-284
  prefs: []
  type: TYPE_PRE
  zh: '[PRE18]'
- en: 'Now, we can run our MCMC sampler to generate the posterior distribution for
    the model parameters:'
  id: totrans-285
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，我们可以运行MCMC采样器以生成模型参数的后验分布：
- en: '[PRE19]'
  id: totrans-286
  prefs: []
  type: TYPE_PRE
  zh: '[PRE19]'
- en: '*Figure 10.17* depicts how the intercept and slope coefficients have changed
    over the years, underlining the evolving correlations:'
  id: totrans-287
  prefs: []
  type: TYPE_NORMAL
  zh: '*图 10.17*描述了截距和斜率系数随时间的变化，强调了演变的相关性：'
- en: '![](img/B15439_10_17.png)'
  id: totrans-288
  prefs: []
  type: TYPE_IMG
  zh: '![](img/B15439_10_17.png)'
- en: 'Figure 10.17: Changes in intercept and slope coefficients over time'
  id: totrans-289
  prefs: []
  type: TYPE_NORMAL
  zh: 图 10.17：截距和斜率系数随时间的变化
- en: Using the dynamic regression coefficients, we can now visualize how the hedge
    ratio suggested by the rolling regression would have changed over the years using
    this Bayesian approach, which models the coefficients as a random walk.
  id: totrans-290
  prefs: []
  type: TYPE_NORMAL
  zh: 使用动态回归系数，我们现在可以通过这种贝叶斯方法来可视化滚动回归建议的对冲比率随时间的变化，该方法将系数建模为随机游走。
- en: 'The following plot combines the prices series and the regression lines, where
    the hue once again indicates the timeline (view this in the notebook for the color
    output):'
  id: totrans-291
  prefs: []
  type: TYPE_NORMAL
  zh: 下图将价格序列和回归线结合在一起，其中色调再次表示时间线（在笔记本中查看以获得彩色输出）：
- en: '![](img/B15439_10_18.png)'
  id: totrans-292
  prefs: []
  type: TYPE_IMG
  zh: '![](img/B15439_10_18.png)'
- en: 'Figure 10.18: Rolling regression lines and price series'
  id: totrans-293
  prefs: []
  type: TYPE_NORMAL
  zh: 图 10.18：滚动回归线和价格序列
- en: For our last example, we'll implement a Bayesian stochastic volatility model.
  id: totrans-294
  prefs: []
  type: TYPE_NORMAL
  zh: 对于我们的最后一个示例，我们将实现一个贝叶斯随机波动模型。
- en: Stochastic volatility models
  id: totrans-295
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 随机波动模型
- en: As discussed in the previous chapter, asset prices have time-varying volatility.
    In some periods, returns are highly variable, while in others, they are very stable.
    We covered ARCH/GARCH models that approach this challenge from a classical linear
    regression perspective in *Chapter 9*, *Time-Series Models for Volatility Forecasts
    and Statistical Arbitrage*.
  id: totrans-296
  prefs: []
  type: TYPE_NORMAL
  zh: 正如前一章所讨论的，资产价格具有时变波动性。在某些时期，收益非常不稳定，而在其他时期则非常稳定。我们在 *第 9 章*，*波动性预测和统计套利的时间序列模型*
    中从经典线性回归的角度探讨了 ARCH/GARCH 模型。
- en: 'Bayesian stochastic volatility models capture this volatility phenomenon with
    a latent volatility variable, modeled as a stochastic process. The No-U-Turn Sampler
    was introduced using such a model (Hoffman, et al. 2011), and the notebook `stochastic_volatility`
    illustrates this use case with daily data for the S&P 500 after 2000\. *Figure
    10.19* shows several volatility clusters throughout the period:'
  id: totrans-297
  prefs: []
  type: TYPE_NORMAL
  zh: 贝叶斯随机波动性模型通过潜在波动性变量捕捉这种波动现象，该变量被建模为随机过程。使用这种模型介绍了无 U 转向采样器 (Hoffman, et al.
    2011)，笔记本 `stochastic_volatility` 使用了 S&P 500 每日数据来说明这种用例。*图 10.19* 显示了此期间的几个波动性集群：
- en: '![](img/B15439_10_19.png)'
  id: totrans-298
  prefs: []
  type: TYPE_IMG
  zh: '![](img/B15439_10_19.png)'
- en: 'Figure 10.19: Daily S&P 500 log returns'
  id: totrans-299
  prefs: []
  type: TYPE_NORMAL
  zh: 图 10.19：每日 S&P 500 对数收益率
- en: The probabilistic model specifies that the log returns follow a t-distribution,
    which has fat tails, as also generally observed for asset returns. The t-distribution
    is governed by the parameter *ν* , which represents the DF. It is also called
    the normality parameter because the t-distribution approaches the normal distribution
    as *ν* increases. This parameter is assumed to have an exponential distribution
    with parameter ![](img/B15439_10_011.png).
  id: totrans-300
  prefs: []
  type: TYPE_NORMAL
  zh: 概率模型规定对数收益率遵循 t 分布，该分布具有厚尾，如资产收益通常观察到的情况。 t 分布受参数 *ν* 控制，表示自由度。它也被称为正态参数，因为
    t 分布在 *ν* 增加时逼近正态分布。假定此参数具有参数 ![](img/B15439_10_011.png) 的指数分布。
- en: 'Furthermore, the log returns are assumed to have mean zero, while the standard
    deviation follows a random walk with a standard deviation that also has an exponential
    distribution:'
  id: totrans-301
  prefs: []
  type: TYPE_NORMAL
  zh: 此外，假定对数收益率的平均值为零，而标准差遵循具有指数分布的标准差随机游走：
- en: '![](img/B15439_10_012.png)'
  id: totrans-302
  prefs: []
  type: TYPE_IMG
  zh: '![](img/B15439_10_012.png)'
- en: 'We implement this model in PyMC3 as follows to mirror its probabilistic specification,
    using log returns to match the model:'
  id: totrans-303
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将此模型实现为 PyMC3，以模仿其概率规范，使用对数收益率匹配模型：
- en: '[PRE20]'
  id: totrans-304
  prefs: []
  type: TYPE_PRE
  zh: '[PRE20]'
- en: 'Next, we draw 5,000 NUTS samples after a burn-in period of 2,000 samples, using
    a higher acceptance rate than the default of 0.8, as recommended for problematic
    posteriors by the PyMC3 docs (see the appropriate links on GitHub):'
  id: totrans-305
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来，在经过 2,000 个样本的燃烧阶段后，我们绘制了 5,000 个 NUTS 样本，使用比默认值 0.8 更高的接受率，根据 PyMC3 文档建议，对于有问题的后验分布（请参阅
    GitHub 上的适当链接）：
- en: '[PRE21]'
  id: totrans-306
  prefs: []
  type: TYPE_PRE
  zh: '[PRE21]'
- en: 'After 28,000 total samples for the four chains, the trace plot in the following
    image confirms that the sampling process has converged:'
  id: totrans-307
  prefs: []
  type: TYPE_NORMAL
  zh: 在四个链总共 28,000 个样本之后，下图中的迹线图证实了采样过程已经收敛：
- en: '![](img/B15439_10_20.png)'
  id: totrans-308
  prefs: []
  type: TYPE_IMG
  zh: '![](img/B15439_10_20.png)'
- en: 'Figure 10.20: Trace plot for the stochastic volatility model'
  id: totrans-309
  prefs: []
  type: TYPE_NORMAL
  zh: 图 10.20：随机波动率模型的迹线图
- en: 'When we plot the samples against the S&P 500 returns in *Figure 10.21*, we
    see that this simple stochastic volatility model tracks the volatility clusters
    fairly well:'
  id: totrans-310
  prefs: []
  type: TYPE_NORMAL
  zh: '当我们将样本绘制到 *图 10.21* 中的 S&P 500 收益率上时，我们可以看到这个简单的随机波动性模型相当好地跟踪了波动性集群： '
- en: '![](img/B15439_10_21.png)'
  id: totrans-311
  prefs: []
  type: TYPE_IMG
  zh: '![](img/B15439_10_21.png)'
- en: 'Figure 10.21: Model'
  id: totrans-312
  prefs: []
  type: TYPE_NORMAL
  zh: 图 10.21：模型
- en: Keep in mind that this represents the in-sample fit. As a next step, you should
    try to evaluate the predictive accuracy. We covered how to make predictions in
    the previous subsection on rolling linear regression and used time-series cross
    validation in several previous chapters, which provides you with all the tools
    you need for this purpose!
  id: totrans-313
  prefs: []
  type: TYPE_NORMAL
  zh: 记住这代表了样本内拟合。作为下一步，你应该尝试评估预测准确性。我们在前面滚动线性回归的子章节中介绍了如何进行预测，并在前几章中使用了时间序列交叉验证，这为您提供了完成此目的所需的所有工具！
- en: Summary
  id: totrans-314
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 概要
- en: In this chapter, we explored Bayesian approaches to machine learning. We saw
    that they have several advantages, including the ability to encode prior knowledge
    or opinions, deeper insights into the uncertainty surrounding model estimates
    and predictions, and suitability for online learning, where each training sample
    incrementally impacts the model's prediction.
  id: totrans-315
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章中，我们探讨了贝叶斯方法与机器学习的结合。我们看到它们有几个优点，包括能够编码先验知识或意见，更深入地了解模型估计和预测周围的不确定性，并适用于在线学习，其中每个训练样本逐渐影响模型的预测。
- en: We learned to apply the Bayesian workflow from model specification to estimation,
    diagnostics, and prediction using PyMC3 and explored several relevant applications.
    We will encounter more Bayesian models in *Chapter 14*, *Text Data for Trading
    – Sentiment Analysis*, where we'll discuss natural language processing and topic
    modeling, and in *Chapter 20*, *Autoencoders for Conditional Risk Factors and
    Asset Pricing*, where we'll introduce variational autoencoders.
  id: totrans-316
  prefs: []
  type: TYPE_NORMAL
  zh: 我们学习了如何使用 PyMC3 应用贝叶斯工作流程，从模型规范到估计、诊断和预测，并探讨了几个相关的应用场景。我们将在*第14章*中遇到更多的贝叶斯模型，*用于交易的文本数据
    - 情感分析*，在那里我们将讨论自然语言处理和主题建模，以及在*第20章*中，*用于条件风险因素和资产定价的自动编码器*，在那里我们将介绍变分自动编码器。
- en: The next chapter introduces nonlinear, tree-based models, namely decision trees,
    and shows how to combine multiple models into an ensemble of trees to create a
    random forest.
  id: totrans-317
  prefs: []
  type: TYPE_NORMAL
  zh: 下一章介绍了非线性的基于树的模型，即决策树，并展示了如何将多个模型组合成一组树的集合，以创建一个随机森林。
